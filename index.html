<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Login Redirect</title>
  <style>
    body {
      background: #0d0d0d;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
  </style>
</head>

<body>
  <h2>Completing Twitch Login…</h2>
  <pre id="log"></pre>

  <script type="module">
    import { PlayerStorage } from "./player-storage.js";

    const CLIENT_ID = "akan5ymak8ah41ad9fh7x0ozd2npnf"; // or xqsb44bk14sw2jo2m2bgi3sz4et4e0
    const REDIRECT_URI = "https://76natsu76.github.io/index.html";

    const logBox = document.getElementById("log");
    function log(msg) {
      console.log(msg);
      logBox.textContent += msg + "\n";
    }

    // Extract URL params
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");
    const error = params.get("error");

    if (error) {
      log("Error: " + error);
      throw new Error(error);
    }

    log("Received code: " + code);
    log("Received state: " + state);

    const savedState = sessionStorage.getItem("oauth_state");
    if (state !== savedState) {
      log("State mismatch!");
      throw new Error("State mismatch");
    }

    const codeVerifier = sessionStorage.getItem("pkce_verifier");

    const WORKER_BASE = "https://auth-worker.godeaterspersona.workers.dev";
    
    async function exchangeCode() {
      log("Exchanging code for token…");
    
      const res = await fetch(WORKER_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          code: code,
          code_verifier: codeVerifier,
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI
        }).toString()
      });
    
      const json = await res.json();
      log("Token response: " + JSON.stringify(json));
    
      if (json.status !== "success") {
        log("Login failed: " + JSON.stringify(json));
        return;
      }
    
      localStorage.setItem("rpg_session", json.session_token);
      localStorage.setItem("rpg_username", json.username);
      localStorage.setItem("rpg_user_id", json.user_id);
    
      window.location.href = "landing.html";
    }

    exchangeCode();
  </script>
</body>
</html>
