<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Login with Twitch</title>

  <style>
    body {
      background: #0d0d0d;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 20px;
      color: #7fffd4;
    }
    button {
      background: #6441a5;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #7d5bbe;
    }
  </style>
</head>

<body>

  <h1>S3ven's RPG</h1>
  <button id="loginBtn">Login with Twitch</button>

  <script>
    const CLIENT_ID = "mbysy0rc683trhf2tfagx0z718qq56";
    const REDIRECT_URI = "https://76natsu76.github.io";

    // PKCE helper: generate random string
    function generateRandomString(length) {
      const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return result;
    }

    // PKCE helper: SHA256 â†’ base64url
    async function sha256ToBase64URL(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      const bytes = new Uint8Array(hash);
      let base64 = btoa(String.fromCharCode(...bytes));
      return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const state = crypto.randomUUID();
      const codeVerifier = generateRandomString(64);
      const codeChallenge = await sha256ToBase64URL(codeVerifier);

      sessionStorage.setItem("oauth_state", state);
      sessionStorage.setItem("pkce_verifier", codeVerifier);

      const url =
        `https://id.twitch.tv/oauth2/authorize` +
        `?client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&response_type=code` +
        `&scope=user:read:email` +
        `&state=${state}` +
        `&code_challenge=${codeChallenge}` +
        `&code_challenge_method=S256`;

      window.location.href = url;
    });
  </script>

</body>
</html>
