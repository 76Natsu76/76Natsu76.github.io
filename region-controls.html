<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Region Controls</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #adminDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }

    .section {
      margin-top:24px;
      padding:16px;
      background:#11141c;
      border-radius:8px;
      border:1px solid #262a36;
    }

    .section h2 {
      margin-top:0;
      font-size:18px;
      color:#9af7ff;
    }

    .region-row {
      display:grid;
      grid-template-columns: 1.4fr 0.7fr 0.7fr 0.8fr 0.8fr 1fr 1fr;
      gap:8px;
      padding:8px 0;
      border-bottom:1px solid #1c1f28;
      align-items:center;
      font-size:13px;
    }

    .region-row.header {
      font-weight:600;
      opacity:0.9;
      border-bottom:1px solid #333;
    }

    input, select, button {
      background:#1a1d24;
      color:#eee;
      border:1px solid #444;
      padding:6px 8px;
      border-radius:4px;
      font-size:13px;
    }

    button {
      cursor:pointer;
    }

    button:hover {
      background:#222832;
    }

    .btn-nav {
      margin-top:16px;
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
    }

    .btn-nav:hover {
      background:#222832;
    }

    #statusMessage {
      margin-top:12px;
      font-size:13px;
      opacity:0.85;
    }
  </style>
</head>

<body>

  <h1>Region Controls</h1>
  <div id="adminDisplay"></div>

  <div class="section">
    <h2>Regions</h2>
    <div id="regionsContainer">Loading regions...</div>
    <div id="statusMessage"></div>
  </div>

  <button class="btn-nav" onclick="goAdmin()">Back to Admin Dashboard</button>

  <script>
    const admin = sessionStorage.getItem("twitch_username");
    document.getElementById("adminDisplay").textContent =
      admin ? "Admin: " + admin : "Not logged in";

    /* ============================================================
       LOAD REGIONS
       ============================================================ */
    async function loadRegions() {
      const container = document.getElementById("regionsContainer");
      container.textContent = "Loading regions...";

      try {
        const res = await fetch("/api/admin/regions", { cache:"no-store" });
        if (!res.ok) {
          container.textContent = "Failed to load regions.";
          return;
        }

        const regions = await res.json();
        renderRegions(regions);
      } catch (err) {
        container.textContent = "Network error: " + err.message;
      }
    }

    /* ============================================================
       RENDER REGIONS
       ============================================================ */
    function renderRegions(list) {
      const container = document.getElementById("regionsContainer");

      if (!list || !list.length) {
        container.innerHTML = "<div>No regions found.</div>";
        return;
      }

      const rows = [];

      rows.push(`
        <div class="region-row header">
          <div>Region</div>
          <div>Enabled</div>
          <div>Danger</div>
          <div>Boost</div>
          <div>Weather</div>
          <div>Blessing</div>
          <div>Actions</div>
        </div>
      `);

      for (const r of list) {
        rows.push(`
          <div class="region-row">
            <div>${format(r.key)}</div>

            <div>
              <select id="enabled-${r.key}">
                <option value="true" ${r.enabled ? "selected" : ""}>Enabled</option>
                <option value="false" ${!r.enabled ? "selected" : ""}>Disabled</option>
              </select>
            </div>

            <div>
              <input id="danger-${r.key}" type="number" step="0.1" value="${r.dangerMultiplier ?? 1}">
            </div>

            <div>
              <input id="boost-${r.key}" type="number" step="0.1" value="${r.encounterBoost ?? 0}">
            </div>

            <div>
              <input id="weather-${r.key}" placeholder="auto or WEATHER_KEY" value="${r.weatherOverride ?? ""}">
            </div>

            <div>
              <input id="bless-${r.key}" placeholder="auto or BLESSING_KEY" value="${r.blessingOverride ?? ""}">
            </div>

            <div>
              <button onclick="saveRegion('${r.key}')">Save</button>
              <button onclick="refreshRegion('${r.key}')">Refresh</button>
            </div>
          </div>
        `);
      }

      container.innerHTML = rows.join("");
    }

    /* ============================================================
       SAVE REGION
       ============================================================ */
    async function saveRegion(key) {
      const enabled = document.getElementById(`enabled-${key}`).value === "true";
      const danger = Number(document.getElementById(`danger-${key}`).value);
      const boost = Number(document.getElementById(`boost-${key}`).value);
      const weather = document.getElementById(`weather-${key}`).value.trim() || null;
      const blessing = document.getElementById(`bless-${key}`).value.trim() || null;

      const payload = {
        admin,
        key,
        enabled,
        dangerMultiplier: danger,
        encounterBoost: boost,
        weatherOverride: weather === "" ? null : weather,
        blessingOverride: blessing === "" ? null : blessing
      };

      try {
        const res = await fetch("/api/admin/regions/update", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payload)
        });

        const data = await res.json();
        document.getElementById("statusMessage").textContent =
          data.message || "Region updated.";
      } catch (err) {
        document.getElementById("statusMessage").textContent =
          "Error updating region: " + err.message;
      }
    }

    /* ============================================================
       FORCE REFRESH
       ============================================================ */
    async function refreshRegion(key) {
      const payload = { admin, key };

      try {
        const res = await fetch("/api/admin/regions/refresh", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payload)
        });

        const data = await res.json();
        document.getElementById("statusMessage").textContent =
          data.message || "Region refreshed.";
      } catch (err) {
        document.getElementById("statusMessage").textContent =
          "Error refreshing region: " + err.message;
      }
    }

    /* ============================================================
       HELPERS
       ============================================================ */
    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g," ")
        .replace(/\b\w/g,c=>c.toUpperCase());
    }

    function goAdmin() {
      window.location.href = "admin-dashboard.html";
    }

    loadRegions();
  </script>

</body>
</html>
