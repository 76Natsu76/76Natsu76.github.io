<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Daily Shop</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }

    #currencyDisplay {
      margin-bottom:12px;
      font-size:16px;
      color:#ffd27f;
    }

    #timer {
      margin-bottom:16px;
      opacity:0.8;
    }

    .item-card {
      padding:12px;
      margin:10px 0;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:relative;
      transition:0.2s;
    }

    .item-card:hover {
      background:#222832;
    }

    .item-info {
      max-width:70%;
    }

    .item-name {
      font-weight:600;
      font-size:15px;
    }

    .item-desc {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-price {
      margin-top:6px;
      font-size:14px;
      color:#ffd27f;
    }

    .item-actions button {
      padding:6px 10px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:12px;
    }

    .item-actions button:hover {
      background:#222832;
    }

    /* Tooltip */
    .tooltip {
      display:none;
      position:absolute;
      left:10px;
      top:100%;
      background:#11141c;
      border:1px solid #262a36;
      padding:10px;
      border-radius:6px;
      width:260px;
      z-index:1000;
      font-size:13px;
    }

    .item-card:hover .tooltip {
      display:block;
    }

    /* Rarity Colors */
    .rarity-common { color:#bfbfbf; }
    .rarity-uncommon { color:#7fff7f; }
    .rarity-rare { color:#7fcfff; }
    .rarity-epic { color:#c77fff; }
    .rarity-legendary { color:#ffbf5f; }

    .btn {
      margin-top:16px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .btn:hover {
      background:#222832;
    }
  </style>
</head>

<body>

  <h1>Daily Shop</h1>
  <div id="usernameDisplay"></div>

  <div id="currencyDisplay"></div>
  <div id="timer"></div>

  <div id="shopContainer">Loading...</div>

  <button class="btn" onclick="goToMap()">World Map</button>
  <button class="btn" onclick="goToInventory()">Inventory</button>

  <script src="api.js"></script>

  <script>
    const username = sessionStorage.getItem("twitch_username");
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";

    let timerInterval = null;

    loadShop();

    /* ============================================================
       LOAD SHOP
       ============================================================ */

    async function loadShop() {
      const container = document.getElementById("shopContainer");
      container.textContent = "Loading...";

      try {
        const data = await api.getDailyShop(username);
        renderShop(data);
      } catch (err) {
        container.textContent = "Error loading daily shop: " + err.message;
      }
    }

    /* ============================================================
       RENDER SHOP
       ============================================================ */

    function renderShop(data) {
      const container = document.getElementById("shopContainer");
      const currencyDisplay = document.getElementById("currencyDisplay");

      currencyDisplay.textContent = `Your Gold: ${data.currency}`;

      // Timer
      const expiresAt = new Date(data.expiresAt);
      startTimer(expiresAt);

      if (!data.items?.length) {
        container.innerHTML = "<div>No items available.</div>";
        return;
      }

      container.innerHTML = data.items
        .map(item => {
          const rarityClass = "rarity-" + item.rarity.toLowerCase();
          return `
            <div class="item-card">
              <div class="item-info">
                <div class="item-name ${rarityClass}">${item.name}</div>
                <div class="item-desc">${item.description || ""}</div>
                <div class="item-price">Price: ${item.price}</div>

                <div class="tooltip">
                  <strong>${item.name}</strong><br>
                  Rarity: ${item.rarity}<br>
                  ${item.bonuses ? formatBonuses(item.bonuses) : ""}
                </div>
              </div>

              <div class="item-actions">
                <button onclick="buyItem('${item.id}')">Buy</button>
              </div>
            </div>
          `;
        })
        .join("");
    }

    /* ============================================================
       BUY ITEM
       ============================================================ */

    async function buyItem(itemId) {
      try {
        const result = await api.buyDailyShopItem(username, itemId);
        alert(result.message || "Purchase complete.");
        loadShop();
      } catch (err) {
        alert("Error purchasing item: " + err.message);
      }
    }

    /* ============================================================
       TIMER
       ============================================================ */

    function startTimer(expiresAt) {
      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const now = new Date();
        const diff = expiresAt - now;

        if (diff <= 0) {
          document.getElementById("timer").textContent = "Shop has refreshed!";
          clearInterval(timerInterval);
          return;
        }

        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        document.getElementById("timer").textContent =
          `Refreshes in: ${h}h ${m}m ${s}s`;
      }, 1000);
    }

    /* ============================================================
       HELPERS
       ============================================================ */

    function formatBonuses(b) {
      return Object.entries(b)
        .map(([k, v]) => `${format(k)}: +${v}`)
        .join("<br>");
    }

    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function goToMap() {
      window.location.href = "world-map.html";
    }

    function goToInventory() {
      window.location.href = "inventory.html";
    }
  </script>

</body>
</html>
