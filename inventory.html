<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Inventory</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #usernameDisplay {
      opacity:0.8;
      margin-bottom:6px;
    }

    #syncIndicator {
      font-size:13px;
      opacity:0.7;
      margin-bottom:16px;
    }

    .btn {
      margin-top:16px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .btn:hover {
      background:#222832;
    }

    /* Collapsible sections */
    .section {
      margin-top:24px;
      padding:16px;
      background:#11141c;
      border-radius:8px;
      border:1px solid #262a36;
    }

    .section h2 {
      margin-top:0;
      font-size:18px;
      color:#9af7ff;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .collapse-arrow {
      font-size:16px;
      opacity:0.7;
      transition:0.2s;
    }

    .collapsed .collapse-arrow {
      transform:rotate(-90deg);
    }

    .collapsed .section-content {
      display:none;
    }

    /* Item cards */
    .item-card,
    .equipment-card {
      padding:10px;
      margin:8px 0;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
    }

    .item-card:hover,
    .equipment-card:hover {
      background:#222832;
    }

    .item-icon {
      width:48px;
      height:48px;
      border-radius:4px;
      border:1px solid #444;
      object-fit:cover;
    }

    .item-info {
      flex-grow:1;
    }

    .item-name {
      font-weight:600;
      font-size:15px;
    }

    .item-qty {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-actions button {
      padding:6px 10px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:12px;
      margin-left:6px;
    }

    .item-actions button:hover {
      background:#222832;
    }

    /* Tooltip */
    .tooltip {
      display:none;
      position:absolute;
      left:10px;
      top:100%;
      background:#11141c;
      border:1px solid #262a36;
      padding:10px;
      border-radius:6px;
      width:260px;
      z-index:1000;
      font-size:13px;
    }

    .item-card:hover .tooltip,
    .equipment-card:hover .tooltip {
      display:block;
    }

    /* Rarity glows */
    .rarity-common { box-shadow:0 0 6px #bfbfbf55; }
    .rarity-uncommon { box-shadow:0 0 8px #7fff7f88; }
    .rarity-rare { box-shadow:0 0 8px #7fcfff88; }
    .rarity-epic { box-shadow:0 0 10px #c77fffaa; }
    .rarity-legendary { box-shadow:0 0 12px #ffbf5faa; }
  </style>
</head>

<body>

  <h1>Inventory</h1>
  <div id="usernameDisplay"></div>
  <div id="syncIndicator">Syncing with server…</div>

  <button class="btn" onclick="refreshInventory()">Refresh</button>

  <div id="inventoryContainer">Loading...</div>

  <button class="btn" onclick="goToCharacter()">Character</button>
  <button class="btn" onclick="goToMap()">World Map</button>

  <script src="api.js"></script>

  <script>
    const username = sessionStorage.getItem("twitch_username");
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";

    let player = null;

    loadInventory();

    async function refreshInventory() {
      document.getElementById("syncIndicator").textContent = "Syncing with server…";
      const fresh = await api.getPlayer(username);
      if (fresh) {
        player = fresh;
        sessionStorage.setItem("player", JSON.stringify(player));
        renderInventory(player);
        document.getElementById("syncIndicator").textContent = "Synced ✔";
      }
    }

    async function loadInventory() {
      const cached = sessionStorage.getItem("player");
      if (cached) {
        player = JSON.parse(cached);
        renderInventory(player);
      }

      if (username) {
        const fresh = await api.getPlayer(username);
        if (fresh) {
          player = fresh;
          sessionStorage.setItem("player", JSON.stringify(player));
          renderInventory(player);
        }
      }

      document.getElementById("syncIndicator").textContent = "Synced ✔";
    }

    /* ============================================================
       RENDER INVENTORY
       ============================================================ */

    function renderInventory(p) {
      const container = document.getElementById("inventoryContainer");
      const out = [];

      /* Categorize items */
      const consumables = [];
      const materials = [];
      const quest = [];
      const misc = [];

      for (const item of p.inventory || []) {
        switch (item.type) {
          case "consumable": consumables.push(item); break;
          case "material": materials.push(item); break;
          case "quest": quest.push(item); break;
          default: misc.push(item); break;
        }
      }

      /* ------------------------------
         EQUIPMENT
      ------------------------------ */
      out.push(`
        <div class="section collapsible">
          <h2 onclick="toggleSection(this)">
            Equipment <span class="collapse-arrow">▼</span>
          </h2>
          <div class="section-content">
            ${
              Object.entries(p.equipment || {})
                .map(([slot, item]) => `
                  <div class="equipment-card rarity-${(item?.rarity || "common").toLowerCase()}">
                    <img class="item-icon"
                         src="${item?.icon || "/assets/items/default.png"}"
                         onerror="this.src='/assets/items/default.png'">

                    <div class="item-info">
                      <div class="item-name">${item ? item.name : "—"}</div>
                      <div class="item-qty">${format(slot)}</div>
                    </div>

                    ${
                      item
                        ? `<div class="tooltip">
                            <strong>${item.name}</strong><br>
                            Rarity: ${format(item.rarity)}<br>
                            ${item.bonuses ? formatBonuses(item.bonuses) : ""}
                          </div>`
                        : ""
                    }

                    ${
                      item
                        ? `<div class="item-actions">
                            <button onclick="unequipItem('${slot}')">Unequip</button>
                          </div>`
                        : ""
                    }
                  </div>
                `)
                .join("")
            }
          </div>
        </div>
      `);

      /* ------------------------------
         CONSUMABLES
      ------------------------------ */
      out.push(renderCategory("Consumables", consumables, true));

      /* ------------------------------
         MATERIALS
      ------------------------------ */
      out.push(renderCategory("Materials", materials, false));

      /* ------------------------------
         QUEST ITEMS
      ------------------------------ */
      out.push(renderCategory("Quest Items", quest, false));

      /* ------------------------------
         MISC
      ------------------------------ */
      out.push(renderCategory("Misc", misc, false));

      container.innerHTML = out.join("");
    }

    function renderCategory(title, items, allowUse) {
      return `
        <div class="section collapsible">
          <h2 onclick="toggleSection(this)">
            ${title} <span class="collapse-arrow">▼</span>
          </h2>
          <div class="section-content">
            ${
              items.length === 0
                ? "<div>No items.</div>"
                : items
                    .map(
                      item => `
              <div class="item-card rarity-${(item.rarity || "common").toLowerCase()}">
                <img class="item-icon"
                     src="${item.icon || "/assets/items/default.png"}"
                     onerror="this.src='/assets/items/default.png'">

                <div class="item-info">
                  <div class="item-name">${item.name}</div>
                  <div class="item-qty">x${item.quantity}</div>

                  <div class="tooltip">
                    <strong>${item.name}</strong><br>
                    Rarity: ${format(item.rarity)}<br>
                    ${item.bonuses ? formatBonuses(item.bonuses) : ""}
                    ${item.description ? `<br>${item.description}` : ""}
                  </div>
                </div>

                <div class="item-actions">
                  ${
                    item.slot
                      ? `<button onclick="equipItem('${item.id}')">Equip</button>`
                      : ""
                  }
                  ${
                    allowUse
                      ? `<button onclick="useItem('${item.id}')">Use</button>`
                      : ""
                  }
                </div>
              </div>
            `
                    )
                    .join("")
            }
          </div>
        </div>
      `;
    }

    /* ============================================================
       ITEM ACTIONS
       ============================================================ */

    async function useItem(itemId) {
      const result = await api.useItem(username, itemId);
      alert(result.message || "Item used.");
      refreshInventory();
    }

    async function equipItem(itemId) {
      const result = await api.equipItem(username, itemId);
      alert(result.message || "Item equipped.");
      refreshInventory();
    }

    async function unequipItem(slot) {
      const result = await api.unequipItem(username, slot);
      alert(result.message || "Item unequipped.");
      refreshInventory();
    }

    /* ============================================================
       HELPERS
       ============================================================ */

    function toggleSection(header) {
      header.parentElement.classList.toggle("collapsed");
    }

    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatBonuses(b) {
      return Object.entries(b)
        .map(([k, v]) => `${format(k)}: +${v}`)
        .join("<br>");
    }

    function goToCharacter() {
      window.location.href = "character.html";
    }

    function goToMap() {
      window.location.href = "world-map.html";
    }
  </script>

</body>
</html>
