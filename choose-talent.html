<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Choose Your Talent</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #info {
      opacity:0.8;
      margin-bottom:12px;
    }

    .branch-card {
      padding:14px;
      margin:12px 0;
      background:#1a1d24;
      border-radius:8px;
      border:1px solid #333;
      cursor:pointer;
    }

    .branch-card:hover {
      background:#222832;
    }

    .selected {
      border-color:#7fffd4;
      box-shadow:0 0 10px #7fffd455;
    }

    .node {
      margin-left:12px;
      padding:6px 0;
      opacity:0.9;
    }

    .node-locked {
      opacity:0.4;
    }

    .btn {
      margin-top:20px;
      padding:12px 16px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
      font-size:16px;
    }

    .btn:hover {
      background:#222832;
    }

    #returnBtn {
      margin-top:12px;
      display:none;
    }

    #saveStatus {
      margin-top:10px;
      opacity:0.8;
    }
  </style>
</head>
<body>

  <h1>Choose Your Talent</h1>
  <div id="info">Select one branch to define your path.</div>

  <div id="talentContainer">Loading talent tree...</div>

  <button id="confirmBtn" class="btn" style="display:none;">Save Talent Choice</button>
  <div id="saveStatus"></div>
  <button id="returnBtn" class="btn">Return to Character</button>

  <script type="module">
    import { requireSession } from "./session-guard.js";
    import { PlayerStorage } from "./player-storage.js";
    import { savePlayerToKV, loadFromKVAndLocal } from "./api.js";
    
    await requireSession();
    const { username } = window.syncState;
    
    let player = PlayerStorage.load(username);

    // FIX talentTree if it was incorrectly stored as an array
    if (!player.talentTree || Array.isArray(player.talentTree)) {
      player.talentTree = { tier1: null, tier2: null, tier3: null };
      PlayerStorage.save(username, player);
    }
    
    /* ============================================================
       LOAD TALENT TREE DEFINITIONS
    ============================================================ */
    const talentDefs = await loadJSON("./profession-talent-trees.json");
    const profession = player.profession;
    
    if (!talentDefs[profession]) {
      document.body.innerHTML = "<h2>No talent tree found for this profession.</h2>";
      throw new Error("No talent tree");
    }
    
    /* ============================================================
       DETERMINE WHICH TIER IS AVAILABLE
    ============================================================ */
    let tier = null;
    
    if (!player.talentTree || !player.talentTree.tier1) {
      if (player.level < 10) {
        document.body.innerHTML = "<h2>You are not eligible for Tier 1 talents yet.</h2>";
        throw new Error("Tier 1 locked");
      }
      tier = "tier1";
    }
    else if (!player.talentTree.tier2) {
      if (player.level < 100) {
        document.body.innerHTML = "<h2>You are not eligible for Tier 2 talents yet.</h2>";
        throw new Error("Tier 2 locked");
      }
      tier = "tier2";
    }
    else if (!player.talentTree.tier3) {
      if (player.level < 1000) {
        document.body.innerHTML = "<h2>You are not eligible for Tier 3 talents yet.</h2>";
        throw new Error("Tier 3 locked");
      }
      tier = "tier3";
    }
    else {
      document.body.innerHTML = "<h2>You have already selected all available talents.</h2>";
      throw new Error("All tiers chosen");
    }
    
    /* ============================================================
       RENDER TALENT BRANCHES
    ============================================================ */
    const tierData = talentDefs[profession][tier];
    const branches = tierData.branches || {};
    let selectedBranch = null;
    
    renderBranches();
    
    function renderBranches() {
      const container = document.getElementById("talentContainer");
      container.innerHTML = `<h2>Select a Tier ${tier.replace("tier","")} Talent</h2>`;
    
      for (const [branchKey, nodes] of Object.entries(branches)) {
        const div = document.createElement("div");
        div.className = "branch-card";
        div.innerHTML = `
          <strong>${format(branchKey)}</strong><br>
          ${renderNodes(nodes)}
        `;
        div.onclick = () => selectBranch(branchKey, div);
        container.appendChild(div);
      }
    }
    
    function renderNodes(nodes) {
      return nodes.map((n, i) => `
        <div class="node ${i === 0 ? "" : "node-locked"}">
          <strong>${n.name}</strong><br>
          <span style="opacity:0.8;">${n.description}</span>
        </div>
      `).join("");
    }
    
    function selectBranch(branchKey, element) {
      selectedBranch = branchKey;
    
      document.querySelectorAll(".branch-card").forEach(el => el.classList.remove("selected"));
      element.classList.add("selected");
    
      document.getElementById("confirmBtn").style.display = "block";
    }
    
    /* ============================================================
       SAVE TALENT CHOICE (LOCAL + KV)
    ============================================================ */
    document.getElementById("confirmBtn").onclick = async () => {
      if (!selectedBranch) return;
    
      if (!player.talentTree) {
        player.talentTree = { tier1: null, tier2: null, tier3: null };
      }
    
      player.talentTree[tier] = selectedBranch;
    
      // Deduct talent points
      const cost = parseInt(tier.replace("tier",""));
      player.talentPoints = (player.talentPoints || 0) - cost;
    
      // Save locally
      PlayerStorage.save(username, player);
    
      // Push to KV using the SAME logic as character.html
      const res = await savePlayerToKV(username, player);
    
      const status = document.getElementById("saveStatus");
      if (res && res.ok) {
        status.textContent = "Saved to KV âœ”";
        document.getElementById("returnBtn").style.display = "block";
        document.getElementById("confirmBtn").style.display = "none";
      } else {
        status.textContent = "Error saving to KV.";
      }
    };
    
    /* ============================================================
       RETURN BUTTON
    ============================================================ */
    document.getElementById("returnBtn").onclick = () => {
      window.location.href = "character.html";
    };
    
    /* ============================================================
       HELPERS
    ============================================================ */
    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error("Failed to load " + path);
      return res.json();
    }
    
    function format(str) {
      return String(str)
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }
    
  </script>

</body>
</html>
