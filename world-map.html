<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>World Map</title>

  <style>
    body {
      background: #0d0f14;
      color: #e8e8e8;
      font-family: system-ui, sans-serif;
      padding: 24px;
    }

    h1 {
      color: #7fffd4;
      margin-bottom: 4px;
    }

    #usernameDisplay {
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .region-card {
      background: #11141c;
      border: 1px solid #262a36;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .region-card h2 {
      margin-top: 0;
      color: #9af7ff;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #1c1f28;
      font-size: 14px;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .event {
      margin-top: 6px;
      padding: 6px;
      background: #1a1d24;
      border-radius: 4px;
      border: 1px solid #333;
      font-size: 13px;
    }

    .btn {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #1a1d24;
      color: #eee;
      cursor: pointer;
    }

    .btn:hover {
      background: #222832;
    }

    .btn.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .section {
      margin-top: 12px;
    }
  </style>
</head>

<body>

  <h1>World Map</h1>
  <div id="usernameDisplay"></div>
  <div id="worldboss-popup" class="popup"></div>
  <div id="mapContainer">Loading world...</div>

  <button class="btn" onclick="goToCharacter()">Character</button>
  <button class="btn" onclick="goToInventory()">Inventory</button>
  <button class="btn" onclick="goToBestiary()">Bestiary</button>

  <!-- Load modules -->
  <script type="module">
    import { WORLD_DATA } from "./world-data.js";
    import { BIOMES } from "./biomes.js";
    import { REGION_TO_BIOME } from "./region-to-biome.js";
    import { EncounterEngine } from "./encounters.js";
    import { WorldSim } from "./world-simulation.js";

    import { requireSession } from "./session-guard.js";
    const session = requireSession();
    if (!session) return;
  
    const username = sessionStorage.getItem("twitch_username");
    const userId = sessionStorage.getItem("twitch_user_id");
  
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";
  
    // Load player data
    let player = JSON.parse(sessionStorage.getItem("player_data") || "{}");
    let playerLevel = Number(player.level || 1);
  
    // ------------------------------------------------------------
    // LOAD WORLD
    // ------------------------------------------------------------
    function loadWorld() {
      const worldState = WorldSim.getState();
      renderWorld(WORLD_DATA, worldState);
    }
  
    // ------------------------------------------------------------
    // RENDER WORLD MAP
    // ------------------------------------------------------------
    function renderWorld(world, worldState) {
      const container = document.getElementById("mapContainer");
      const out = [];
  
      for (const regionKey in world.regions) {
        const region = world.regions[regionKey];
        const state = worldState[regionKey];
  
        // Resolve biome
        const biomeKey = REGION_TO_BIOME[regionKey] || region.biome;
        const biome = BIOMES[biomeKey];
  
        // Level range
        const [minLevel, maxLevel] = region.levelRange || [1, 999];
        const levelLocked = playerLevel < minLevel;
  
        // Global unlock (world boss progression)
        const globallyUnlocked = state.unlocked;
  
        // World boss lock (region sealed until boss defeated)
        const bossActive = !!state.worldBoss;
        const bossLocked = !globallyUnlocked;
  
        // Combined lock logic
        const regionLocked = levelLocked || bossLocked;
  
        // Flavor text
        const biomeFlavor = biome?.flavor
          ? biome.flavor[Math.floor(Math.random() * biome.flavor.length)]
          : "Unknown biome.";
  
        const regionFlavor = region.flavor || "";
  
        // Weather preview
        const weatherPreview = region.weatherPool?.join(", ") ||
                               biome?.weatherPool?.join(", ") ||
                               "Unknown";
  
        // Hazards
        const hazards = biome?.hazards?.length
          ? biome.hazards.map(h => h.key).join(", ")
          : "None";
  
        // Events
        const events = region.eventPool?.length
          ? region.eventPool.map(e => `<div class="event">${format(e)}</div>`).join("")
          : "<div class='event'>None</div>";
  
        // Lock message
        let lockMessage = "";
        if (levelLocked) lockMessage = `Requires Lv ${minLevel}`;
        else if (bossLocked) lockMessage = `Locked — Defeat the World Boss`;
  
        out.push(`
          <div class="region-card">
            <h2>${region.name}</h2>
  
            <div class="stat-row"><span>Biome</span><span>${format(biomeKey)}</span></div>
            <div class="stat-row"><span>Weather</span><span>${weatherPreview}</span></div>
            <div class="stat-row"><span>Hazards</span><span>${hazards}</span></div>
            <div class="stat-row"><span>Danger</span><span>${region.danger || "Moderate"}</span></div>
            <div class="stat-row"><span>Blessing</span><span>${region.blessing || "None"}</span></div>
  
            <div class="stat-row">
              <span>World Boss</span>
              <span>${bossActive ? "Active" : globallyUnlocked ? "Defeated" : "Locked"}</span>
            </div>
  
            <div class="stat-row">
              <span>Level Range</span>
              <span>${minLevel} - ${maxLevel}</span>
            </div>
  
            <div class="section">
              <strong>Biome Flavor:</strong>
              <div class="event">${biomeFlavor}</div>
            </div>
  
            <div class="section">
              <strong>Region Flavor:</strong>
              <div class="event">${regionFlavor}</div>
            </div>
  
            <div class="section">
              <strong>Events:</strong>
              ${events}
            </div>
  
            <button class="btn ${regionLocked ? "disabled" : ""}"
              onclick="enterRegion('${regionKey}', ${regionLocked})">
              ${regionLocked ? lockMessage : "Enter Region"}
            </button>
          </div>
        `);
      }
  
      container.innerHTML = out.join("");
    }
  
    // ------------------------------------------------------------
    // ENTER REGION → GENERATE ENCOUNTER
    // ------------------------------------------------------------
    window.enterRegion = function(regionKey, locked) {
      if (locked) return;
  
      const encounter = EncounterEngine.generate(regionKey, username);
      sessionStorage.setItem("current_encounter", JSON.stringify(encounter));
      window.location.href = "fight-interactive.html";
    };
  
    // ------------------------------------------------------------
    // HELPERS
    // ------------------------------------------------------------
    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/-/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }
  
    window.goToCharacter = () => window.location.href = "character.html";
    window.goToInventory = () => window.location.href = "inventory.html";
    window.goToBestiary = () => window.location.href = "bestiary.html";
  
    loadWorld();
  </script>
</body>
</html>
