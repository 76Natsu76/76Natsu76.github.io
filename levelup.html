<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Level Up</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }

    .section {
      margin-top:24px;
      padding:16px;
      background:#11141c;
      border-radius:8px;
      border:1px solid #262a36;
    }

    .section h2 {
      margin-top:0;
      font-size:18px;
      color:#9af7ff;
    }

    .stat-row {
      display:flex;
      justify-content:space-between;
      padding:4px 0;
      border-bottom:1px solid #1c1f28;
      font-size:14px;
    }

    .stat-row:last-child {
      border-bottom:none;
    }

    .xp-bar {
      width:100%;
      height:20px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      margin-top:8px;
      overflow:hidden;
    }

    .xp-fill {
      height:100%;
      background:#7fffd4;
      width:0%;
      transition:width 0.6s ease-out;
    }

    .btn {
      margin-top:16px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .btn:hover {
      background:#222832;
    }

    #levelupMessage {
      margin-top:16px;
      font-size:18px;
      color:#7fffd4;
      font-weight:bold;
      display:none;
      text-align:center;
      animation:pop 0.4s ease-out;
    }

    @keyframes pop {
      from { transform:scale(0.85); opacity:0; }
      to   { transform:scale(1); opacity:1; }
    }
  </style>
</head>

<body>

  <h1>Level Up</h1>
  <div id="usernameDisplay"></div>

  <div id="levelContainer">Loading...</div>

  <button class="btn" onclick="goToCharacter()">Character</button>
  <button class="btn" onclick="goToMap()">World Map</button>

  <script src="api.js"></script>
  <script type="module">
    import { requireSession } from "./session-guard.js";
    const session = requireSession();
    if (!session) return;
  
    const username = session.username;
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";
  
    let player = null;
  
    loadPlayer();
  
    async function loadPlayer() {
      const container = document.getElementById("levelContainer");
  
      if (!username) {
        container.textContent = "Error: No username found.";
        return;
      }
  
      try {
        player = await api.getPlayer(username);
        renderLevelUI(player);
      } catch (err) {
        container.textContent = "Network error: " + err.message;
      }
    }
  
    function renderLevelUI(player) {
      const container = document.getElementById("levelContainer");
  
      const xpPercent =
        player.xpRequired > 0
          ? Math.min(100, Math.floor((player.xp / player.xpRequired) * 100))
          : 0;
  
      container.innerHTML = `
        <div class="section">
          <h2>Level Progress</h2>
  
          <div class="stat-row"><span>Level</span><span>${player.level}</span></div>
          <div class="stat-row"><span>XP</span><span>${player.xp} / ${
        player.xpRequired
      }</span></div>
  
          <div class="xp-bar">
            <div class="xp-fill" id="xpFill" style="width:${xpPercent}%"></div>
          </div>
  
          <button class="btn" onclick="attemptLevelUp()">Level Up</button>
  
          <div id="levelupMessage"></div>
        </div>
  
        <div class="section">
          <h2>Stats</h2>
          ${
            Object.entries(player.derived || {})
              .map(
                ([k, v]) =>
                  `<div class="stat-row"><span>${format(k)}</span><span>${v}</span></div>`
              )
              .join("")
          }
        </div>
      `;
    }
  
    async function attemptLevelUp() {
      try {
        const result = await api.levelUp(username);
  
        const msg = document.getElementById("levelupMessage");
        msg.textContent = result.message || "Level Up!";
        msg.style.display = "block";
  
        await loadPlayer();
      } catch (err) {
        const msg = document.getElementById("levelupMessage");
        msg.textContent = "Error: " + err.message;
        msg.style.display = "block";
      }
    }
  
    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }
  
    function goToCharacter() {
      window.location.href = "character.html";
    }
  
    function goToMap() {
      window.location.href = "world-map.html";
    }
  </script>

</body>
</html>
