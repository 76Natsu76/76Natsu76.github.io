<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Combat</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }
    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }
    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }
    .panel {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:16px;
      margin-bottom:20px;
    }
    .panel h2 {
      margin-top:0;
      color:#9af7ff;
    }
    .hp-bar {
      height:12px;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      margin-top:6px;
    }
    .actions button {
      display:block;
      width:100%;
      margin-top:10px;
      padding:10px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:15px;
    }
    .actions button:hover {
      background:#222832;
    }
    .primary {
      background:#2e7d32;
      border-color:#1b5e20;
    }
    .primary:hover {
      background:#388e3c;
    }

    #log {
      background:#000;
      border:1px solid #333;
      padding:12px;
      border-radius:6px;
      font-family:monospace;
      font-size:14px;
      max-height:50vh;
      overflow-y:auto;
      white-space:pre-wrap;
    }
    /* Reward panel */
    .reward-box {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:20px;
      margin-top:20px;
      animation: rewardFade 0.6s ease-out;
    }

    @keyframes rewardFade {
      from {
        opacity:0; transform:translateY(10px);
      }
      to {
        opacity:1; transform:translateY(0);
      }
    }

    /* XP bar */
    .xp-bar {
      margin-top:10px;
      height:14px;
      background:#333;
      border-radius:7px;
      overflow:hidden;
    }

    .xp-fill {
      height:100%;
      background:#7fcfff;
      width:0%;
      transition: width 1s ease-in-out;
    }

    /* Loot card */
    .loot-card {
      margin-top:12px;
      padding:12px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      animation: lootPop 0.4s ease-out;
    }

    @keyframes lootPop {
      0% {
        transform:scale(0.8); opacity:0;
      }
      100% {
        transform:scale(1); opacity:1;
      }
    }

    /* Rarity glow */
    .loot-common {
      border-color:#bfbfbf;
    }
    .loot-uncommon {
      border-color:#7fff7f; box-shadow:0 0 6px #7fff7f55;
    }
    .loot-rare {
      border-color:#7fcfff; box-shadow:0 0 6px #7fcfff55;
    }
    .loot-epic {
      border-color:#c77fff; box-shadow:0 0 6px #c77fff55;
    }
    .loot-legendary {
      border-color:#ffbf5f; box-shadow:0 0 6px #ffbf5f55;
    }

    /* Level-up highlight */
    .level-up {
      margin-top:10px;
      padding:10px;
      background:#2e7d32;
      border-radius:6px;
      border:1px solid #1b5e20;
      color:#fff;
      animation: levelUpGlow 1.2s infinite ease-in-out;
    }

    @keyframes levelUpGlow {
      0% {
        box-shadow:0 0 6px rgba(46,125,50,0.4);
      }
      50% {
        box-shadow:0 0 12px rgba(46,125,50,0.9);
      }
      100% {
        box-shadow:0 0 6px rgba(46,125,50,0.4);
      }
    }

    /* Continue buttons */
    .reward-btn {
      margin-top:14px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .reward-btn:hover {
      background:#222832;
    }

    .modal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }

    .modal-content {
      background:#11141c;
      border:1px solid #262a36;
      padding:20px;
      border-radius:8px;
      width:400px;
    }

    .close-btn {
      margin-top:12px;
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
    }

    .close-btn:hover {
      background:#222832;
    }

    /* Enemy inspection */
    .inspect-row {
      margin:6px 0;
      font-size:14px;
      opacity:0.9;
    }

    .inspect-ability {
      padding:6px;
      margin:4px 0;
      background:#1a1d24;
      border-radius:4px;
      border:1px solid #333;
    }

    /* Equipment swap */
    .swap-slot,
    .swap-item {
      padding:8px;
      margin:6px 0;
      background:#1a1d24;
      border-radius:4px;
      border:1px solid #333;
      cursor:pointer;
    }

    .swap-slot:hover,
    .swap-item:hover {
      background:#222832;
    }

    /* HP bar animations */
    .hp-fill {
      transition: width 0.6s ease-in-out;
    }

    .damage-flash {
      animation: damageFlash 0.4s ease-out;
    }

    @keyframes damageFlash {
      0% {
        background-color: rgba(255,0,0,0.6);
      }
      100% {
        background-color: transparent;
      }
    }

    .heal-flash {
      animation: healFlash 0.4s ease-out;
    }

    @keyframes healFlash {
      0% {
        background-color: rgba(0,255,0,0.6);
      }
      100% {
        background-color: transparent;
      }
    }

    /* Ability card with icon */
    .ability-card {
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      margin:8px 0;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      position:relative;
    }

    .ability-icon {
      width:48px;
      height:48px;
      border-radius:4px;
      background:#000;
      border:1px solid #444;
      object-fit:cover;
    }

    /* Tooltip */
    .ability-tooltip {
      display:none;
      position:absolute;
      left:60px;
      top:0;
      background:#11141c;
      border:1px solid #262a36;
      padding:10px;
      border-radius:6px;
      width:260px;
      z-index:1000;
      font-size:13px;
    }

    .ability-card:hover .ability-tooltip {
      display:block;
    }

    /* Cooldown overlay */
    .cooldown-overlay {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      color:#fff;
      font-size:20px;
      display:flex;
      justify-content:center;
      align-items:center;
      border-radius:6px;
      pointer-events:none;
    }

    /* Disabled ability */
    .ability-disabled {
      opacity:0.4;
      pointer-events:none;
    }

    /* Ultimate charge bar container */
    .ult-bar {
      margin-top:8px;
      height:12px;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      position:relative;
    }

    /* Fill */
    .ult-fill {
      height:100%;
      background:#ffbf5f;
      width:0%;
      transition: width 0.6s ease-in-out;
    }

    /* Glow when ready */
    .ult-ready-glow {
      animation: ultGlow 1.2s infinite ease-in-out;
    }

    @keyframes ultGlow {
      0% {
        box-shadow: 0 0 6px rgba(255,191,95,0.4);
      }
      50% {
        box-shadow: 0 0 12px rgba(255,191,95,0.9);
      }
      100% {
        box-shadow: 0 0 6px rgba(255,191,95,0.4);
      }
    }

    /* Pulse when used */
    .ult-pulse {
      animation: ultPulse 0.5s ease-out;
    }

    @keyframes ultPulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.15);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Portrait frame */
    .portrait-frame {
      width:140px;
      height:140px;
      border-radius:8px;
      overflow:hidden;
      border:2px solid #444;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      margin:0 auto;
      position:relative;
    }

    /* Portrait image */
    .portrait-img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Rarity glow */
    .portrait-common {
      box-shadow:0 0 6px #bfbfbf55;
    }
    .portrait-uncommon {
      box-shadow:0 0 8px #7fff7f88;
    }
    .portrait-rare {
      box-shadow:0 0 8px #7fcfff88;
    }
    .portrait-epic {
      box-shadow:0 0 8px #c77fff88;
    }
    .portrait-legendary {
      box-shadow:0 0 10px #ffbf5faa;
    }

    /* Cinematic intro panel */
    .cinematic-intro {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:2000;
      animation: introFadeIn 0.6s ease-out;
    }

    @keyframes introFadeIn {
      from {
        opacity:0;
      }
      to {
        opacity:1;
      }
    }

    .cinematic-content {
      text-align:center;
      animation: introPop 0.5s ease-out;
    }

    @keyframes introPop {
      0% {
        transform:scale(0.8); opacity:0;
      }
      100% {
        transform:scale(1); opacity:1;
      }
    }

    .vs-text {
      font-size:48px;
      font-weight:700;
      color:#ffbf5f;
      margin-top:20px;
      text-shadow:0 0 12px #ffbf5f;
    }

    /* Roar shake */
    .roar-shake {
      animation: roarShake 0.5s ease-in-out;
    }

    @keyframes roarShake {
      0% {
        transform:translateX(0);
      }
      20% {
        transform:translateX(-8px);
      }
      40% {
        transform:translateX(8px);
      }
      60% {
        transform:translateX(-6px);
      }
      80% {
        transform:translateX(6px);
      }
      100% {
        transform:translateX(0);
      }
    }

    /* Screen shake */
    .screen-shake {
      animation: screenShake 0.4s ease-in-out;
    }

    @keyframes screenShake {
      0% {
        transform:translate(0,0);
      }
      20% {
        transform:translate(-6px, 4px);
      }
      40% {
        transform:translate(6px, -4px);
      }
      60% {
        transform:translate(-4px, 2px);
      }
      80% {
        transform:translate(4px, -2px);
      }
      100% {
        transform:translate(0,0);
      }
    }

    /* Crit flash */
    .crit-flash {
      animation: critFlash 0.4s ease-out;
    }

    @keyframes critFlash {
      0% {
        box-shadow:0 0 12px rgba(255,255,0,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,255,0,0);
      }
    }

    /* Elemental pulses */
    .fire-pulse {
      animation: firePulse 0.5s ease-out;
    }

    @keyframes firePulse {
      0% {
        box-shadow:0 0 12px rgba(255,80,0,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,80,0,0);
      }
    }

    .ice-pulse {
      animation: icePulse 0.5s ease-out;
    }

    @keyframes icePulse {
      0% {
        box-shadow:0 0 12px rgba(120,200,255,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(120,200,255,0);
      }
    }

    .lightning-pulse {
      animation: lightningPulse 0.5s ease-out;
    }

    @keyframes lightningPulse {
      0% {
        box-shadow:0 0 12px rgba(255,255,120,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,255,120,0);
      }
    }

    /* DOT/HOT tick flash */
    .dot-tick {
      animation: dotTick 0.4s ease-out;
    }

    @keyframes dotTick {
      0% {
        background-color:rgba(255,80,0,0.4);
      }
      100% {
        background-color:transparent;
      }
    }

    .hot-tick {
      animation: hotTick 0.4s ease-out;
    }
    @keyframes hotTick {
      0% {
        background-color:rgba(80,255,80,0.4);
      }
      100% {
        background-color:transparent;
      }
    }

    /* Modifier row */
    .modifier-row {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
      padding:8px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      font-size:14px;
    }
    /* Modifier icon */
    .modifier-icon {
      width:32px;
      height:32px;
      object-fit:contain;
    }
    /* Modifier label */
    .modifier-label {
      opacity:0.9;
    }
    /* Modifier container */
    .modifier-box {
      margin-top:16px;
    }
    /* Modal backdrop */
    .item-modal {
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.65);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:9999;
      transition:0.2s;
    }

    .item-modal.hidden {
      opacity:0;
      pointer-events:none;
    }

    /* Modal window */
    .item-modal-content {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:10px;
      padding:20px;
      width:420px;
      max-height:80vh;
      overflow-y:auto;
      animation:popIn 0.25s ease-out;
    }

    @keyframes popIn {
      from { transform:scale(0.85); opacity:0; }
      to   { transform:scale(1); opacity:1; }
    }

    .item-entry {
      background:#1a1d24;
      border:1px solid #333;
      border-radius:6px;
      padding:12px;
      margin:10px 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:0.15s;
    }

    .item-entry:hover {
      background:#222832;
    }

    .item-info {
      max-width:70%;
    }

    .item-name {
      font-weight:600;
      font-size:15px;
    }

    .item-desc {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-qty {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-actions button {
      padding:6px 10px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:12px;
    }

    .item-actions button:hover {
      background:#222832;
    }

    /* Rarity colors */
    .rarity-common {
      color:#bfbfbf;
    }
    .rarity-uncommon {
      color:#7fff7f;
    }
    .rarity-rare {
      color:#7fcfff;
    }
    .rarity-epic {
      color:#c77fff;
    }
    .rarity-legendary {
      color:#ffbf5f;
    }

  </style>
</head>
<body>

  <!-- ============================
        HEADER / USER DISPLAY
  ============================= -->
  <div id="usernameDisplay" class="username-display"></div>

  <!-- ============================
        REGION SELECTOR + START
  ============================= -->
  <div class="fight-controls">
    <label for="regionSelect">Region:</label>
    <select id="regionSelect">
      <option value="forest">Forest</option>
      <option value="mountains">Mountains</option>
      <option value="swamp">Swamp</option>
      <option value="desert">Desert</option>
    </select>

    <button id="startFightBtn" class="btn start-btn">Start Fight</button>
  </div>
  
  <!-- ============================
       PLAYER / ENEMY HUD
  ============================= -->
  <div id="combatHud" class="combat-hud">
    <div id="playerPanel" class="hud-panel player-panel">
      <div class="hud-header">
        <span id="playerName" class="hud-name">Player</span>
        <span id="playerLevel" class="hud-level">Lv 1</span>
      </div>
  
      <div class="hud-bar hp-bar">
        <div id="playerHpFill" class="bar-fill"></div>
        <span id="playerHpText" class="bar-text">HP 0 / 0</span>
      </div>
  
      <div class="hud-bar mana-bar">
        <div id="playerManaFill" class="bar-fill"></div>
        <span id="playerManaText" class="bar-text">MP 0 / 0</span>
      </div>
  
      <div class="hud-bar ult-bar">
        <div id="playerUltFill" class="bar-fill"></div>
        <span id="playerUltText" class="bar-text">ULT 0%</span>
      </div>
    </div>
  
    <div id="enemyPanel" class="hud-panel enemy-panel">
      <div class="hud-header">
        <span id="enemyName" class="hud-name">Enemy</span>
        <span id="enemyLevel" class="hud-level">Lv 1</span>
      </div>
  
      <div class="hud-bar hp-bar">
        <div id="enemyHpFill" class="bar-fill"></div>
        <span id="enemyHpText" class="bar-text">HP 0 / 0</span>
      </div>
  
      <div class="hud-bar mana-bar">
        <div id="enemyManaFill" class="bar-fill"></div>
        <span id="enemyManaText" class="bar-text">MP 0 / 0</span>
      </div>
  
      <button id="inspectEnemyBtn" class="btn inspect-btn">Inspect</button>
    </div>
  </div>

  <!-- ============================
        COMBAT LOG
  ============================= -->
  <div id="combatLog" class="combat-log"></div>

  <!-- ============================
        ACTION PANEL (PLAYER TURN)
  ============================= -->
  <div id="actionPanel" class="action-panel" style="display:none;">
    <button id="basicAttackBtn" class="btn action-btn">Basic Attack</button>
    <button id="openAbilitiesBtn" class="btn action-btn"
            onclick="document.getElementById('abilityPanel').style.display='block'">
      Abilities
    </button>
    <button id="ultimateBtn" class="btn action-btn">Ultimate</button>
    <button id="openItemBtn" class="btn action-btn"
            onclick="document.getElementById('itemModal').style.display='block'">
      Item
    </button>
    <button id="fleeBtn" class="btn action-btn">Flee</button>
    <button id="autoBtn" class="btn action-btn">Auto</button>
  </div>

  <!-- ============================
        ABILITY PANEL
  ============================= -->
  <div id="abilityPanel" class="ability-panel" style="display:none;">
    <h3>Choose Ability</h3>
    <div id="abilityList"></div>
    <button class="btn close-btn"
            onclick="document.getElementById('abilityPanel').style.display='none'">
      Close
    </button>
  </div>

  <!-- ============================
        ITEM MODAL
  ============================= -->
  <div id="itemModal" class="item-modal hidden">
    <div class="item-modal-content">
      <h2>Use Item</h2>
      <div id="itemList">Loading...</div>
      <button class="btn close-btn"
              onclick="document.getElementById('itemModal').style.display='none'">
        Close
      </button>
    </div>
  </div>

  <!-- ============================
        CINEMATIC INTRO
  ============================= -->
  <div id="cinematicIntro" class="cinematic-intro" style="display:none;">
    <div class="cinematic-content">
      <div id="cinematicPortrait" class="portrait-frame"></div>
      <div id="cinematicName" class="cinematic-name"></div>
      <div class="vs-text">VS</div>
    </div>
  </div>

  <!-- ============================
        RESUME PREVIOUS FIGHT MODAL
  ============================= -->
  <div id="resumeModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Resume Previous Fight?</h2>
      <p>You have an unfinished battle. Would you like to continue it?</p>

      <button class="btn" onclick="resumeFight()">Resume</button>
      <button class="btn" onclick="startNewFight()">Start New Fight</button>
    </div>
  </div>

  <!-- ============================
        TURN-BASED COMBAT WIRING
  ============================= -->
  <script type="module">
    import { startCombat, runCombatRound } from "./combat-flow.js";

    const logBox = document.getElementById("combatLog");
    const actionPanel = document.getElementById("actionPanel");
    const abilityPanel = document.getElementById("abilityPanel");
    const itemModal = document.getElementById("itemModal");

    let combat = null;
    let autoBattle = false;

    function addLog(line) {
      const div = document.createElement("div");
      div.textContent = line;
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    }

    function renderLogs(logs) {
      for (const line of logs) addLog(line);
    }

    async function beginFight() {
      logBox.innerHTML = "";
    
      const rawPlayer = JSON.parse(localStorage.getItem("playerData"));
      if (!rawPlayer) {
        addLog("No player loaded.");
        return;
      }
    
      const regionKey = document.getElementById("regionSelect").value;
    
      combat = startCombat(rawPlayer.username, regionKey);
      renderLogs(combat.logs);
      renderPanels(); // ← HUD
    
      if (combat.outcome) {
        addLog("Combat ended immediately: " + combat.outcome);
        return;
      }
    
      showActionPanel();
    }
    
    async function runRound(playerAction) {
      hideActionPanel();
    
      const result = runCombatRound(combat, playerAction);
      renderLogs(result.logs);
      renderPanels(); // ← HUD
    
      // If you later pipe context.events through applyVFX:
      // (result.events || []).forEach(applyVFX);
    
      if (result.outcome) {
        addLog("Combat ended: " + result.outcome.toUpperCase());
        return;
      }
    
      if (autoBattle) {
        autoLoop();
      } else {
        showActionPanel();
      }
    }

    // HELPER FUNCTIONS
    function renderPanels() {
      if (!combat) return;
      renderPlayerPanel(combat.playerState);
      renderEnemyPanel(combat.enemyState);
    }
    
    function renderPlayerPanel(p) {
      if (!p) return;
    
      document.getElementById("playerName").textContent = p.name || "Player";
      document.getElementById("playerLevel").textContent = "Lv " + (p.level || 1);
    
      updateHPBar("playerHpFill", "playerHpText", p.hpCurrent, p.hpMax);
      updateManaBar("playerManaFill", "playerManaText", p.manaCurrent, p.manaMax);
      updateUltimateBar(p);
    }
    
    function renderEnemyPanel(e) {
      if (!e) return;
    
      document.getElementById("enemyName").textContent = e.name || "Enemy";
      document.getElementById("enemyLevel").textContent = "Lv " + (e.level || 1);
    
      updateHPBar("enemyHpFill", "enemyHpText", e.hpCurrent, e.hpMax);
      updateManaBar("enemyManaFill", "enemyManaText", e.manaCurrent || 0, e.manaMax || 0);
    }
    
    function updateHPBar(fillId, textId, current, max) {
      const fill = document.getElementById(fillId);
      const text = document.getElementById(textId);
    
      current = current || 0;
      max = max || 1;
    
      const pct = Math.max(0, Math.min(100, (current / max) * 100));
      if (fill) fill.style.width = pct + "%";
      if (text) text.textContent = `HP ${current} / ${max}`;
    }
    
    function updateManaBar(fillId, textId, current, max) {
      const fill = document.getElementById(fillId);
      const text = document.getElementById(textId);
    
      current = current || 0;
      max = max || 0;
    
      const pct = max > 0 ? Math.max(0, Math.min(100, (current / max) * 100)) : 0;
      if (fill) fill.style.width = pct + "%";
      if (text) text.textContent = `MP ${current} / ${max}`;
    }
    
    function updateUltimateBar(playerState) {
      const fill = document.getElementById("playerUltFill");
      const text = document.getElementById("playerUltText");
    
      const charge = playerState.ultimateCharge || 0;
      const required = playerState.ultimateChargeRequired || 100;
    
      const pct = Math.max(0, Math.min(100, (charge / required) * 100));
      if (fill) fill.style.width = pct + "%";
      if (text) text.textContent = `ULT ${Math.round(pct)}%`;
    }

    // VFX HOOKS
    function screenShake(intensity = 5, duration = 150) {
      const root = document.body;
      root.classList.add("screen-shake");
      setTimeout(() => root.classList.remove("screen-shake"), duration);
    }
    
    function critFlash() {
      const log = document.getElementById("combatLog");
      log.classList.add("crit-flash");
      setTimeout(() => log.classList.remove("crit-flash"), 200);
    }
    
    function elementalPulse(element) {
      // e.g. add a class like `pulse-fire`, `pulse-ice`, etc.
      const hud = document.getElementById("combatHud");
      if (!hud) return;
      hud.classList.add(`pulse-${element}`);
      setTimeout(() => hud.classList.remove(`pulse-${element}`), 300);
    }
    
    function applyVFX(event) {
      // Hook this into your logEvent types later
      if (!event || !event.type) return;
    
      if (event.type === "crit") critFlash();
      if (event.type === "big_hit") screenShake();
      if (event.type === "elemental_hit" && event.payload?.element) {
        elementalPulse(event.payload.element);
      }
    }
    
    // Simple HOT / DOT tick hooks (you can expand later)
    function hotTick(target) {
      // animate healing on HUD if you want
    }
    
    function dotTick(target) {
      // animate damage-over-time on HUD if you want
    }


    async function chooseBasicAttack() { await runRound({ type: "basic" }); }
    async function chooseAbility(key) { await runRound({ type: "ability", key }); }
    async function chooseUltimate() { await runRound({ type: "ultimate" }); }
    async function chooseItem(itemId) { await runRound({ type: "item", itemId }); }
    async function chooseFlee() { await runRound({ type: "flee" }); }

    async function toggleAutoBattle() {
      autoBattle = !autoBattle;
      addLog("Auto-battle: " + (autoBattle ? "ON" : "OFF"));
      if (autoBattle) autoLoop();
    }

    async function autoLoop() {
      if (!autoBattle) return;
      const action = { type: "basic" };
      await runRound(action);
    }

    function showActionPanel() { actionPanel.style.display = "block"; }
    function hideActionPanel() { actionPanel.style.display = "none"; }

    document.getElementById("startFightBtn").onclick = beginFight;
    document.getElementById("basicAttackBtn").onclick = chooseBasicAttack;
    document.getElementById("ultimateBtn").onclick = chooseUltimate;
    document.getElementById("fleeBtn").onclick = chooseFlee;
    document.getElementById("autoBtn").onclick = toggleAutoBattle;

    window.chooseAbility = chooseAbility;
    window.chooseItem = chooseItem;
  </script>
</body>
</html>
