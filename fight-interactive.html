<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Combat</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }
    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }
    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }
    .panel {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:16px;
      margin-bottom:20px;
    }
    .panel h2 {
      margin-top:0;
      color:#9af7ff;
    }
    .hp-bar {
      height:12px;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      margin-top:6px;
    }
    .actions button {
      display:block;
      width:100%;
      margin-top:10px;
      padding:10px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:15px;
    }
    .actions button:hover {
      background:#222832;
    }
    .primary {
      background:#2e7d32;
      border-color:#1b5e20;
    }
    .primary:hover {
      background:#388e3c;
    }

    #log {
      background:#000;
      border:1px solid #333;
      padding:12px;
      border-radius:6px;
      font-family:monospace;
      font-size:14px;
      max-height:50vh;
      overflow-y:auto;
      white-space:pre-wrap;
    }
    /* Reward panel */
    .reward-box {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:20px;
      margin-top:20px;
      animation: rewardFade 0.6s ease-out;
    }

    @keyframes rewardFade {
      from {
        opacity:0; transform:translateY(10px);
      }
      to {
        opacity:1; transform:translateY(0);
      }
    }

    /* XP bar */
    .xp-bar {
      margin-top:10px;
      height:14px;
      background:#333;
      border-radius:7px;
      overflow:hidden;
    }

    .xp-fill {
      height:100%;
      background:#7fcfff;
      width:0%;
      transition: width 1s ease-in-out;
    }

    /* Loot card */
    .loot-card {
      margin-top:12px;
      padding:12px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      animation: lootPop 0.4s ease-out;
    }

    @keyframes lootPop {
      0% {
        transform:scale(0.8); opacity:0;
      }
      100% {
        transform:scale(1); opacity:1;
      }
    }

    /* Rarity glow */
    .loot-common {
      border-color:#bfbfbf;
    }
    .loot-uncommon {
      border-color:#7fff7f; box-shadow:0 0 6px #7fff7f55;
    }
    .loot-rare {
      border-color:#7fcfff; box-shadow:0 0 6px #7fcfff55;
    }
    .loot-epic {
      border-color:#c77fff; box-shadow:0 0 6px #c77fff55;
    }
    .loot-legendary {
      border-color:#ffbf5f; box-shadow:0 0 6px #ffbf5f55;
    }

    /* Level-up highlight */
    .level-up {
      margin-top:10px;
      padding:10px;
      background:#2e7d32;
      border-radius:6px;
      border:1px solid #1b5e20;
      color:#fff;
      animation: levelUpGlow 1.2s infinite ease-in-out;
    }

    @keyframes levelUpGlow {
      0% {
        box-shadow:0 0 6px rgba(46,125,50,0.4);
      }
      50% {
        box-shadow:0 0 12px rgba(46,125,50,0.9);
      }
      100% {
        box-shadow:0 0 6px rgba(46,125,50,0.4);
      }
    }

    /* Continue buttons */
    .reward-btn {
      margin-top:14px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .reward-btn:hover {
      background:#222832;
    }

    .modal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }

    .modal-content {
      background:#11141c;
      border:1px solid #262a36;
      padding:20px;
      border-radius:8px;
      width:400px;
    }

    .close-btn {
      margin-top:12px;
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
    }

    .close-btn:hover {
      background:#222832;
    }

    /* Enemy inspection */
    .inspect-row {
      margin:6px 0;
      font-size:14px;
      opacity:0.9;
    }

    .inspect-ability {
      padding:6px;
      margin:4px 0;
      background:#1a1d24;
      border-radius:4px;
      border:1px solid #333;
    }

    /* Equipment swap */
    .swap-slot,
    .swap-item {
      padding:8px;
      margin:6px 0;
      background:#1a1d24;
      border-radius:4px;
      border:1px solid #333;
      cursor:pointer;
    }

    .swap-slot:hover,
    .swap-item:hover {
      background:#222832;
    }

    /* HP bar animations */
    .hp-fill {
      transition: width 0.6s ease-in-out;
    }

    .damage-flash {
      animation: damageFlash 0.4s ease-out;
    }

    @keyframes damageFlash {
      0% {
        background-color: rgba(255,0,0,0.6);
      }
      100% {
        background-color: transparent;
      }
    }

    .heal-flash {
      animation: healFlash 0.4s ease-out;
    }

    @keyframes healFlash {
      0% {
        background-color: rgba(0,255,0,0.6);
      }
      100% {
        background-color: transparent;
      }
    }

    /* Ability card with icon */
    .ability-card {
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      margin:8px 0;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      position:relative;
    }

    .ability-icon {
      width:48px;
      height:48px;
      border-radius:4px;
      background:#000;
      border:1px solid #444;
      object-fit:cover;
    }

    /* Tooltip */
    .ability-tooltip {
      display:none;
      position:absolute;
      left:60px;
      top:0;
      background:#11141c;
      border:1px solid #262a36;
      padding:10px;
      border-radius:6px;
      width:260px;
      z-index:1000;
      font-size:13px;
    }

    .ability-card:hover .ability-tooltip {
      display:block;
    }

    /* Cooldown overlay */
    .cooldown-overlay {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      color:#fff;
      font-size:20px;
      display:flex;
      justify-content:center;
      align-items:center;
      border-radius:6px;
      pointer-events:none;
    }

    /* Disabled ability */
    .ability-disabled {
      opacity:0.4;
      pointer-events:none;
    }

    /* Ultimate charge bar container */
    .ult-bar {
      margin-top:8px;
      height:12px;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      position:relative;
    }

    /* Fill */
    .ult-fill {
      height:100%;
      background:#ffbf5f;
      width:0%;
      transition: width 0.6s ease-in-out;
    }

    /* Glow when ready */
    .ult-ready-glow {
      animation: ultGlow 1.2s infinite ease-in-out;
    }

    @keyframes ultGlow {
      0% {
        box-shadow: 0 0 6px rgba(255,191,95,0.4);
      }
      50% {
        box-shadow: 0 0 12px rgba(255,191,95,0.9);
      }
      100% {
        box-shadow: 0 0 6px rgba(255,191,95,0.4);
      }
    }

    /* Pulse when used */
    .ult-pulse {
      animation: ultPulse 0.5s ease-out;
    }

    @keyframes ultPulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.15);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Portrait frame */
    .portrait-frame {
      width:140px;
      height:140px;
      border-radius:8px;
      overflow:hidden;
      border:2px solid #444;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      margin:0 auto;
      position:relative;
    }

    /* Portrait image */
    .portrait-img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Rarity glow */
    .portrait-common {
      box-shadow:0 0 6px #bfbfbf55;
    }
    .portrait-uncommon {
      box-shadow:0 0 8px #7fff7f88;
    }
    .portrait-rare {
      box-shadow:0 0 8px #7fcfff88;
    }
    .portrait-epic {
      box-shadow:0 0 8px #c77fff88;
    }
    .portrait-legendary {
      box-shadow:0 0 10px #ffbf5faa;
    }

    /* Cinematic intro panel */
    .cinematic-intro {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:2000;
      animation: introFadeIn 0.6s ease-out;
    }

    @keyframes introFadeIn {
      from {
        opacity:0;
      }
      to {
        opacity:1;
      }
    }

    .cinematic-content {
      text-align:center;
      animation: introPop 0.5s ease-out;
    }

    @keyframes introPop {
      0% {
        transform:scale(0.8); opacity:0;
      }
      100% {
        transform:scale(1); opacity:1;
      }
    }

    .vs-text {
      font-size:48px;
      font-weight:700;
      color:#ffbf5f;
      margin-top:20px;
      text-shadow:0 0 12px #ffbf5f;
    }

    /* Roar shake */
    .roar-shake {
      animation: roarShake 0.5s ease-in-out;
    }

    @keyframes roarShake {
      0% {
        transform:translateX(0);
      }
      20% {
        transform:translateX(-8px);
      }
      40% {
        transform:translateX(8px);
      }
      60% {
        transform:translateX(-6px);
      }
      80% {
        transform:translateX(6px);
      }
      100% {
        transform:translateX(0);
      }
    }

    /* Screen shake */
    .screen-shake {
      animation: screenShake 0.4s ease-in-out;
    }

    @keyframes screenShake {
      0% {
        transform:translate(0,0);
      }
      20% {
        transform:translate(-6px, 4px);
      }
      40% {
        transform:translate(6px, -4px);
      }
      60% {
        transform:translate(-4px, 2px);
      }
      80% {
        transform:translate(4px, -2px);
      }
      100% {
        transform:translate(0,0);
      }
    }

    /* Crit flash */
    .crit-flash {
      animation: critFlash 0.4s ease-out;
    }

    @keyframes critFlash {
      0% {
        box-shadow:0 0 12px rgba(255,255,0,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,255,0,0);
      }
    }

    /* Elemental pulses */
    .fire-pulse {
      animation: firePulse 0.5s ease-out;
    }

    @keyframes firePulse {
      0% {
        box-shadow:0 0 12px rgba(255,80,0,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,80,0,0);
      }
    }

    .ice-pulse {
      animation: icePulse 0.5s ease-out;
    }

    @keyframes icePulse {
      0% {
        box-shadow:0 0 12px rgba(120,200,255,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(120,200,255,0);
      }
    }

    .lightning-pulse {
      animation: lightningPulse 0.5s ease-out;
    }

    @keyframes lightningPulse {
      0% {
        box-shadow:0 0 12px rgba(255,255,120,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,255,120,0);
      }
    }

    /* DOT/HOT tick flash */
    .dot-tick {
      animation: dotTick 0.4s ease-out;
    }

    @keyframes dotTick {
      0% {
        background-color:rgba(255,80,0,0.4);
      }
      100% {
        background-color:transparent;
      }
    }

    .hot-tick {
      animation: hotTick 0.4s ease-out;
    }
    @keyframes hotTick {
      0% {
        background-color:rgba(80,255,80,0.4);
      }
      100% {
        background-color:transparent;
      }
    }

    /* Modifier row */
    .modifier-row {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
      padding:8px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      font-size:14px;
    }
    /* Modifier icon */
    .modifier-icon {
      width:32px;
      height:32px;
      object-fit:contain;
    }
    /* Modifier label */
    .modifier-label {
      opacity:0.9;
    }
    /* Modifier container */
    .modifier-box {
      margin-top:16px;
    }
    /* Modal backdrop */
    .item-modal {
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.65);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:9999;
      transition:0.2s;
    }

    .item-modal.hidden {
      opacity:0;
      pointer-events:none;
    }

    /* Modal window */
    .item-modal-content {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:10px;
      padding:20px;
      width:420px;
      max-height:80vh;
      overflow-y:auto;
      animation:popIn 0.25s ease-out;
    }

    @keyframes popIn {
      from { transform:scale(0.85); opacity:0; }
      to   { transform:scale(1); opacity:1; }
    }

    .item-entry {
      background:#1a1d24;
      border:1px solid #333;
      border-radius:6px;
      padding:12px;
      margin:10px 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:0.15s;
    }

    .item-entry:hover {
      background:#222832;
    }

    .item-info {
      max-width:70%;
    }

    .item-name {
      font-weight:600;
      font-size:15px;
    }

    .item-desc {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-qty {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-actions button {
      padding:6px 10px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:12px;
    }

    .item-actions button:hover {
      background:#222832;
    }

    /* Rarity colors */
    .rarity-common {
      color:#bfbfbf;
    }
    .rarity-uncommon {
      color:#7fff7f;
    }
    .rarity-rare {
      color:#7fcfff;
    }
    .rarity-epic {
      color:#c77fff;
    }
    .rarity-legendary {
      color:#ffbf5f;
    }

  </style>
</head>
<body>
  <h1>Combat</h1>
  <div id="usernameDisplay"></div>

  <!-- ============================
       ENEMY PANEL
  ============================ -->
  <div id="enemyPanel" class="panel">Loading enemy...</div>

  <!-- ============================
       PLAYER PANEL
  ============================ -->
  <div id="playerPanel" class="panel">Loading player...</div>

  <!-- ============================
       ACTION PANEL
  ============================ -->
  <div id="actionPanel" class="panel actions" style="display:none;">
    <h2>Choose Your Action</h2>

    <button onclick="inspectEnemy()">Inspect Enemy</button>
    <button onclick="attemptFlee()">Flee</button>

    <button class="primary" onclick="playerBasicAttack()">Basic Attack</button>

    <button onclick="openAbilityMenu()">Use Ability</button>
    <button onclick="useUltimate()">Use Ultimate</button>

    <button class="btn" onclick="openItemModal()">Use Item</button>
    <button onclick="openSwapMenu()">Swap Equipment</button>
  </div>

  <!-- ============================
       COMBAT LOG
  ============================ -->
  <div id="log" class="panel">Waiting...</div>

  <!-- ============================
       REWARD PANEL
  ============================ -->
  <div id="rewardPanel" style="display:none;"></div>

  <!-- ============================
       ABILITY MENU MODAL
  ============================ -->
  <div id="abilityMenu" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Your Abilities</h2>

      <div id="abilityList">Loading...</div>

      <button class="close-btn" onclick="closeAbilityMenu()">Close</button>
    </div>
  </div>

  <!-- ============================
       ENEMY INSPECTION MODAL
  ============================ -->
  <div id="inspectMenu" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Enemy Info</h2>

      <div id="inspectContent">Loading...</div>

      <button class="close-btn" onclick="closeInspectMenu()">Close</button>
    </div>
  </div>

  <!-- ============================
       EQUIPMENT SWAP MODAL
  ============================ -->
  <div id="swapMenu" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Swap Equipment</h2>

      <div id="swapSlotList">Loading...</div>
      <div id="swapItemList" style="margin-top:12px;"></div>

      <button class="close-btn" onclick="closeSwapMenu()">Close</button>
    </div>
  </div>

  <!-- ============================
       IN-COMBAT ITEM MODAL
  ============================= -->
  <div id="itemModal" class="item-modal hidden">
    <div class="item-modal-content">
      <h2>Use Item</h2>

      <div id="itemList">Loading...</div>

      <button class="btn close-btn" onclick="closeItemModal()">Close</button>
    </div>
  </div>

  <select id="regionSelect">
    <option value="forest">Forest</option>
    <option value="mountains">Mountains</option>
    <option value="swamp">Swamp</option>
    <option value="desert">Desert</option>
  </select>
  
  <button id="startFightBtn">Start Fight</button>
  
  <div id="combatLog" style="
    width: 100%;
    height: 400px;
    overflow-y: auto;
    background: #111;
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    border: 1px solid #333;
  "></div>

  <!-- ============================
       CINEMATIC INTRO
  ============================ -->
  <div id="cinematicIntro" class="cinematic-intro" style="display:none;">
    <div class="cinematic-content">
      <div id="cinematicPortrait" class="portrait-frame"></div>
      <div id="cinematicName" style="margin-top:12px; font-size:24px;"></div>
      <div class="vs-text">VS</div>
    </div>
  </div>

  <!-- ============================
       RESUME PREVIOUS FIGHT MODAL
  ============================= -->
  <div id="resumeModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Resume Previous Fight?</h2>
      <p>You have an unfinished battle. Would you like to continue it?</p>

      <button class="close-btn" onclick="resumeFight()">Resume</button>
      <button class="close-btn" onclick="startNewFight()">Start New Fight</button>
    </div>
  </div>

  <!-- ============================
      SCRIPTS
  ============================= -->
  <script src="combat-engine.js"></script>

  <script>
    /* ============================================================
       INITIALIZATION
       ============================================================ */

    const username = sessionStorage.getItem("twitch_username");
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";

    // Load player + encounter from sessionStorage
    let player = JSON.parse(sessionStorage.getItem("player"));
    let encounter = JSON.parse(sessionStorage.getItem("encounter"));
    let combatState = null;

    // If no encounter exists, redirect back to map
    if (!encounter) {
      document.getElementById("log").textContent =
        "No encounter found. Returning to map...";
      setTimeout(() => (window.location.href = "world-map.html"), 1200);
    }

    // Create combat engine
    let engine = null;

    /* ============================================================
       START / RESUME COMBAT
       ============================================================ */

    function startCombat() {
      document.getElementById("log").textContent = "Starting encounter...";

      engine = new CombatEngine(player, encounter, {
        onUpdate: updateUI,
        onLog: addLog,
        onEnd: endCombat
      });

      combatState = engine.getState();

      renderPanels();
      showCinematicIntro(combatState.enemy);

      if (combatState.turn === "ENEMY") {
        enemyTurn();
      } else {
        showActionPanel();
      }
    }

    function resumeFight() {
      engine = new CombatEngine(player, encounter, {
        onUpdate: updateUI,
        onLog: addLog,
        onEnd: endCombat
      });

      combatState = engine.getState();
      renderPanels();
      document.getElementById("resumeModal").style.display = "none";

      if (combatState.turn === "PLAYER") {
        showActionPanel();
      } else {
        enemyTurn();
      }
    }

    function startNewFight() {
      document.getElementById("resumeModal").style.display = "none";
      // Clear any previous saved combat
      sessionStorage.removeItem("savedCombat");
      startCombat();
    }

    // If a saved combat exists in sessionStorage
    if (sessionStorage.getItem("savedCombat")) {
      combatState = JSON.parse(sessionStorage.getItem("savedCombat"));
      document.getElementById("resumeModal").style.display = "flex";
    } else {
      startCombat();
    }

    /* ============================================================
       UI RENDERING
       ============================================================ */

    function renderPanels() {
      renderEnemyPanel();
      renderPlayerPanel();
      renderLog();
    }

    function renderEnemyPanel() {
      const e = combatState.enemy;
      const container = document.getElementById("enemyPanel");
      const previousHP = Number(container.getAttribute("data-prev-hp")) || e.hpMax;

      let modifiersHTML = "";
      if (e.modifiers?.length) {
        modifiersHTML = `
          <div class="modifier-box">
            ${e.modifiers
              .map(
                (m) => `
              <div class="modifier-row">
                <img class="modifier-icon" src="${m.icon}">
                <div class="modifier-label">${m.text}</div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
      }

      container.innerHTML = `
        <div class="portrait-frame portrait-${e.rarity.toLowerCase()}">
          <img class="portrait-img" src="${e.portrait}">
        </div>

        <h2 style="text-align:center; margin-top:12px;">
          ${format(e.name)} (Lv ${e.level})
        </h2>

        <div style="text-align:center;">
          Rarity: <span class="rarity-${e.rarity.toLowerCase()}">${format(
        e.rarity
      )}</span>
        </div>

        <div class="hp-bar" id="enemyHPBar">
          <div class="hp-fill" style="width:0%;"></div>
        </div>

        ${modifiersHTML}
      `;

      updateHPBar("enemyHPBar", previousHP, e.hp, e.hpMax);
      container.setAttribute("data-prev-hp", e.hp);
    }

    function renderPlayerPanel() {
      const p = combatState.player;
      const container = document.getElementById("playerPanel");

      const previousHP = Number(container.getAttribute("data-prev-hp")) || p.hpMax;
      const previousUlt =
        Number(container.getAttribute("data-prev-ult")) || p.ultCharge;

      const abilityCooldowns = p.cooldowns
        .map((c) => `${c.name}: ${c.remaining}`)
        .join("<br>");

      container.innerHTML = `
        <h2>${format(p.name)} (Lv ${p.level})</h2>

        <div>Ultimate: ${p.ultReady ? "READY" : p.ultCharge + "%"}</div>

        <div class="ult-bar" id="ultBar">
          <div class="ult-fill"></div>
        </div>

        <div class="hp-bar" id="playerHPBar">
          <div class="hp-fill" style="width:0%;"></div>
        </div>

        <div style="margin-top:8px; font-size:13px; opacity:0.8;">
          ${abilityCooldowns}
        </div>
      `;

      updateHPBar("playerHPBar", previousHP, p.hp, p.hpMax);
      updateUltimateBar("ultBar", previousUlt, p.ultCharge);

      container.setAttribute("data-prev-hp", p.hp);
      container.setAttribute("data-prev-ult", p.ultCharge);
    }

    function renderLog() {
      document.getElementById("log").textContent =
        combatState.log.map(formatLog).join("\n");

      combatState.log.forEach((entry) => applyVFX(entry));
    }

    /* ============================================================
       UI HELPERS
       ============================================================ */

    function updateUI(state) {
      combatState = state;
      renderPanels();
    }

    function addLog(text) {
      const log = document.getElementById("log");
      log.textContent += text + "\n";
      log.scrollTop = log.scrollHeight;
    }

    function showActionPanel() {
      document.getElementById("actionPanel").style.display = "block";
    }

    function hideActionPanel() {
      document.getElementById("actionPanel").style.display = "none";
    }

    function updateHPBar(elementId, oldHP, newHP, maxHP) {
      const pct = Math.max(0, (newHP / maxHP) * 100);
      const bar = document.querySelector(`#${elementId} .hp-fill`);
      if (!bar) return;

      if (newHP < oldHP) bar.classList.add("damage-flash");
      else if (newHP > oldHP) bar.classList.add("heal-flash");

      bar.style.width = pct + "%";

      setTimeout(() => {
        bar.classList.remove("damage-flash");
        bar.classList.remove("heal-flash");
      }, 500);
    }

    function updateUltimateBar(elementId, oldCharge, newCharge) {
      const bar = document.querySelector(`#${elementId} .ult-fill`);
      if (!bar) return;

      bar.style.width = newCharge + "%";

      if (newCharge >= 100) bar.classList.add("ult-ready-glow");
      else bar.classList.remove("ult-ready-glow");

      if (newCharge < oldCharge) {
        bar.classList.add("ult-pulse");
        setTimeout(() => bar.classList.remove("ult-pulse"), 500);
      }
    }

    /* ============================================================
       PLAYER ACTIONS
       ============================================================ */

    async function playerBasicAttack() {
      hideActionPanel();
      addLog("\nPlayer acts...\n");
      await engine.basicAttack();
    }

    async function useUltimate() {
      hideActionPanel();
      addLog("\nPlayer uses Ultimate...\n");
      await engine.useUltimate();
    }

    async function attemptFlee() {
      hideActionPanel();
      addLog("\nPlayer attempts to flee...\n");
      await engine.flee();
    }

    async function useAbility(key) {
      closeAbilityMenu();
      hideActionPanel();
      addLog(`\nPlayer uses ${key}...\n`);
      await engine.useAbility(key);
    }

    /* ============================================================
       ENEMY TURN
       ============================================================ */

    async function enemyTurn() {
      hideActionPanel();
      addLog("\nEnemy acts...\n");
      await engine.enemyTurn();
      if (!combatState.outcome && combatState.turn === "PLAYER") {
        showActionPanel();
      }
    }

    /* ============================================================
       END COMBAT
       ============================================================ */

    function endCombat(result) {
      hideActionPanel();

      const r = result || {};
      const rewardPanel = document.getElementById("rewardPanel");

      let lootHTML = "None";
      if (r.loot) {
        const rarityClass = "loot-" + r.loot.rarity.toLowerCase();
        lootHTML = `
          <div class="loot-card ${rarityClass}">
            <strong>${r.loot.name}</strong><br>
            <span>${r.loot.quantity}x — ${format(r.loot.rarity)}</span>
          </div>
        `;
      }

      const levelUpHTML = r.levelUp
        ? `<div class="level-up">Level Up! You are now level ${r.newLevel}</div>`
        : "";

      rewardPanel.innerHTML = `
        <div class="reward-box">
          <h2>Rewards</h2>

          <div>XP Gained: ${r.xp || 0}</div>

          <div class="xp-bar">
            <div class="xp-fill" id="xpFill"></div>
          </div>

          ${levelUpHTML}

          <h3 style="margin-top:16px;">Loot</h3>
          ${lootHTML}

          <button class="reward-btn" onclick="goToMap()">Return to Map</button>
          <button class="reward-btn" onclick="continueExploring()">Continue Exploring</button>
        </div>
      `;

      rewardPanel.style.display = "block";

      setTimeout(() => {
        if (document.getElementById("xpFill")) {
          document.getElementById("xpFill").style.width = (r.xpPercent || 0) + "%";
        }
      }, 50);
    }

    function goToMap() {
      window.location.href = "world-map.html";
    }

    function continueExploring() {
      const region = encounter.region;
      window.location.href = `world-map.html?region=${region}`;
    }

    /* ============================================================
       ABILITY MENU
       ============================================================ */

    function openAbilityMenu() {
      loadAbilities();
      document.getElementById("abilityMenu").style.display = "flex";
    }

    function closeAbilityMenu() {
      document.getElementById("abilityMenu").style.display = "none";
    }

    function loadAbilities() {
      const list = document.getElementById("abilityList");
      const abilities = combatState.player.abilities;
      const cooldowns = combatState.player.cooldowns;

      list.innerHTML = abilities
        .map((a) => {
          const cd = cooldowns.find((c) => c.key === a.key);
          const remaining = cd ? cd.remaining : 0;
          const disabled = remaining > 0 ? "ability-disabled" : "";

          return `
            <div class="ability-card ${disabled}" onclick="useAbility('${a.key}')">
              <img class="ability-icon" src="${a.icon}">
              <div>
                <strong>${a.name}</strong><br>
                <span style="opacity:0.8;">${a.description}</span>
              </div>
              ${
                remaining > 0
                  ? `<div class="cooldown-overlay">${remaining}</div>`
                  : ""
              }
            </div>
          `;
        })
        .join("");
    }

    /* ============================================================
       EQUIPMENT SWAP
       ============================================================ */

    function openSwapMenu() {
      const p = combatState.player;
      const slotList = document.getElementById("swapSlotList");
      const itemList = document.getElementById("swapItemList");

      itemList.innerHTML = "";

      slotList.innerHTML = Object.entries(p.equipment)
        .map(
          ([slot, item]) => `
          <div class="swap-slot" onclick="selectSwapSlot('${slot}')">
            <strong>${format(slot)}</strong>: ${item ? item.name : "—"}
          </div>
        `
        )
        .join("");

      document.getElementById("swapMenu").style.display = "flex";
    }

    function closeSwapMenu() {
      document.getElementById("swapMenu").style.display = "none";
    }

    function selectSwapSlot(slot) {
      const p = combatState.player;
      const itemList = document.getElementById("swapItemList");

      const items = p.inventoryEquipment || [];

      if (!items.length) {
        itemList.innerHTML = "<div>No equipment available.</div>";
        return;
      }

      itemList.innerHTML = items
        .map(
          (i) => `
          <div class="swap-item" onclick="confirmSwap('${slot}', '${i.id}')">
            <strong>${i.name}</strong><br>
            <span class="rarity-${i.rarity.toLowerCase()}">${format(
            i.rarity
          )}</span>
          </div>
        `
        )
        .join("");
    }

    async function confirmSwap(slot, itemId) {
      closeSwapMenu();
      await engine.swapEquipment(slot, itemId);
    }

    /* ============================================================
       INSPECT ENEMY
       ============================================================ */

    function inspectEnemy() {
      const e = combatState.enemy;
      const box = document.getElementById("inspectContent");

      box.innerHTML = `
        <div class="inspect-row"><strong>Name:</strong> ${format(e.name)}</div>
        <div class="inspect-row"><strong>Level:</strong> ${e.level}</div>
        <div class="inspect-row"><strong>Rarity:</strong> ${format(
          e.rarity
        )}</div>
        <div class="inspect-row"><strong>Family:</strong> ${format(
          e.family
        )}</div>
        <div class="inspect-row"><strong>HP:</strong> ${e.hp}/${e.hpMax}</div>
        <div class="inspect-row"><strong>Element:</strong> ${format(
          e.element
        )}</div>
      `;

      document.getElementById("inspectMenu").style.display = "flex";
    }

    function closeInspectMenu() {
      document.getElementById("inspectMenu").style.display = "none";
    }

    /* ============================================================
       CINEMATIC INTRO
       ============================================================ */

    function showCinematicIntro(enemy) {
      const intro = document.getElementById("cinematicIntro");
      const portrait = document.getElementById("cinematicPortrait");
      const name = document.getElementById("cinematicName");

      portrait.className = `portrait-frame portrait-${enemy.rarity.toLowerCase()}`;
      portrait.innerHTML = `
        <img class="portrait-img" src="${enemy.portrait}">
      `;

      name.textContent = `${format(enemy.name)} (Lv ${enemy.level})`;

      intro.style.display = "flex";

      portrait.classList.add("roar-shake");
      setTimeout(() => portrait.classList.remove("roar-shake"), 600);

      setTimeout(() => {
        intro.style.display = "none";
      }, 1800);
    }

    /* ============================================================
       VFX HELPERS
       ============================================================ */

    function applyVFX(entry) {
      if (!entry || typeof entry !== "object") return;

      const target =
        entry.target === "PLAYER" ? "playerPanel" : "enemyPanel";

      if (entry.type === "attack") {
        screenShake();
        if (entry.crit) critFlash(target);
        if (entry.element) elementalPulse(target, entry.element.toLowerCase());
      }

      if (entry.type === "dot") dotTick(target);
      if (entry.type === "hot") hotTick(target);
    }

    function screenShake() {
      document.body.classList.add("screen-shake");
      setTimeout(() => document.body.classList.remove("screen-shake"), 400);
    }

    function critFlash(targetPanelId) {
      const panel = document.getElementById(targetPanelId);
      panel.classList.add("crit-flash");
      setTimeout(() => panel.classList.remove("crit-flash"), 400);
    }

    function elementalPulse(targetPanelId, element) {
      const panel = document.getElementById(targetPanelId);
      const cls = `${element}-pulse`;
      panel.classList.add(cls);
      setTimeout(() => panel.classList.remove(cls), 500);
    }

    function dotTick(targetPanelId) {
      const panel = document.getElementById(targetPanelId);
      panel.classList.add("dot-tick");
      setTimeout(() => panel.classList.remove("dot-tick"), 400);
    }

    function hotTick(targetPanelId) {
      const panel = document.getElementById(targetPanelId);
      panel.classList.add("hot-tick");
      setTimeout(() => panel.classList.remove("hot-tick"), 400);
    }

    /* ============================================================
       HELPERS
       ============================================================ */

    function formatLog(entry) {
      if (typeof entry === "string") return entry;

      switch (entry.type) {
        case "attack":
          return `${entry.attacker} hits ${entry.target} for ${entry.damage} dmg`;
        case "dot":
          return `${entry.effectKey} deals ${entry.amount} DOT`;
        case "hot":
          return `${entry.effectKey} heals ${entry.amount} HOT`;
        case "expire":
          return `${entry.effectKey} expired`;
        default:
          return JSON.stringify(entry);
      }
    }

    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }

    /* ============================================================
       OPEN / CLOSE ITEM MODAL
       ============================================================ */

    function openItemModal() {
      const modal = document.getElementById("itemModal");
      modal.classList.remove("hidden");
      loadCombatItems();
    }

    function closeItemModal() {
      const modal = document.getElementById("itemModal");
      modal.classList.add("hidden");
    }

    /* ============================================================
       LOAD USABLE ITEMS DURING COMBAT (CLIENT-SIDE)
       ============================================================ */

    function loadCombatItems() {
      const list = document.getElementById("itemList");
      list.textContent = "Loading...";

      const p = combatState.player;
      const usable = (p.inventory || []).filter(
        (i) => i.type === "consumable"
      );

      if (!usable.length) {
        list.innerHTML = "<div>No usable items.</div>";
        return;
      }

      list.innerHTML = usable
        .map((item) => {
          const rarityClass =
            "rarity-" + (item.rarity || "common").toLowerCase();
          return `
            <div class="item-entry">
              <div class="item-info">
                <div class="item-name ${rarityClass}">${item.name}</div>
                <div class="item-desc">${item.description || item.meta?.description || ""}</div>
                <div class="item-qty">x${item.quantity}</div>
              </div>
              <div class="item-actions">
                <button onclick="useCombatItem('${item.id}')">Use</button>
              </div>
            </div>
          `;
        })
        .join("");
    }

    /* ============================================================
       USE ITEM DURING COMBAT (CLIENT-SIDE)
       ============================================================ */

    async function useCombatItem(itemId) {
      try {
        hideActionPanel();
        addLog("\nPlayer uses an item...\n");
        await engine.useItem(itemId);
        closeItemModal();
      } catch (err) {
        alert("Error using item: " + err.message);
      }
    }

  </script>
  <script type="module">
  import { startCombat } from "./combat-flow.js";

  // UI elements
  const startBtn = document.getElementById("startFightBtn");
  const logBox   = document.getElementById("combatLog");
  const regionSel = document.getElementById("regionSelect");

  // Replace this with your real player loader
  async function loadPlayer() {
    const raw = JSON.parse(localStorage.getItem("playerData"));
    return raw;
  }

  function renderLogs(logs) {
    logBox.innerHTML = "";
    for (const line of logs) {
      const div = document.createElement("div");
      div.textContent = line;
      logBox.appendChild(div);
    }
    logBox.scrollTop = logBox.scrollHeight;
  }

  async function handleStartFight() {
    logBox.innerHTML = "Starting combat…";

    const player = await loadPlayer();
    if (!player) {
      logBox.innerHTML = "No player loaded.";
      return;
    }

    const regionKey = regionSel.value || "forest";

    try {
      const result = startCombat(player.username, regionKey);
      renderLogs(result.logs);
    } catch (err) {
      logBox.innerHTML = "Combat error: " + err.message;
      console.error(err);
    }
  }

  startBtn.addEventListener("click", handleStartFight);
</script>
</body>
</html>
