<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Combat</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }
    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }
    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }
    .panel {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:16px;
      margin-bottom:20px;
    }
    .panel h2 {
      margin-top:0;
      color:#9af7ff;
    }
    .hp-bar {
      height:12px;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      margin-top:6px;
    }
    .actions button {
      display:block;
      width:100%;
      margin-top:10px;
      padding:10px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:15px;
    }
    .actions button:hover {
      background:#222832;
    }
    .primary {
      background:#2e7d32;
      border-color:#1b5e20;
    }
    .primary:hover {
      background:#388e3c;
    }

    #log {
      background:#000;
      border:1px solid #333;
      padding:12px;
      border-radius:6px;
      font-family:monospace;
      font-size:14px;
      max-height:50vh;
      overflow-y:auto;
      white-space:pre-wrap;
    }
    /* Reward panel */
    .reward-box {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:20px;
      margin-top:20px;
      animation: rewardFade 0.6s ease-out;
    }

    @keyframes rewardFade {
      from {
        opacity:0; transform:translateY(10px);
      }
      to {
        opacity:1; transform:translateY(0);
      }
    }

    /* XP bar */
    .xp-bar {
      margin-top:10px;
      height:14px;
      background:#333;
      border-radius:7px;
      overflow:hidden;
    }

    .xp-fill {
      height:100%;
      background:#7fcfff;
      width:0%;
      transition: width 1s ease-in-out;
    }

    /* Loot card */
    .loot-card {
      margin-top:12px;
      padding:12px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      animation: lootPop 0.4s ease-out;
    }

    @keyframes lootPop {
      0% {
        transform:scale(0.8); opacity:0;
      }
      100% {
        transform:scale(1); opacity:1;
      }
    }

    /* Rarity glow */
    .loot-common {
      border-color:#bfbfbf;
    }
    .loot-uncommon {
      border-color:#7fff7f; box-shadow:0 0 6px #7fff7f55;
    }
    .loot-rare {
      border-color:#7fcfff; box-shadow:0 0 6px #7fcfff55;
    }
    .loot-epic {
      border-color:#c77fff; box-shadow:0 0 6px #c77fff55;
    }
    .loot-legendary {
      border-color:#ffbf5f; box-shadow:0 0 6px #ffbf5f55;
    }

    /* Level-up highlight */
    .level-up {
      margin-top:10px;
      padding:10px;
      background:#2e7d32;
      border-radius:6px;
      border:1px solid #1b5e20;
      color:#fff;
      animation: levelUpGlow 1.2s infinite ease-in-out;
    }

    @keyframes levelUpGlow {
      0% {
        box-shadow:0 0 6px rgba(46,125,50,0.4);
      }
      50% {
        box-shadow:0 0 12px rgba(46,125,50,0.9);
      }
      100% {
        box-shadow:0 0 6px rgba(46,125,50,0.4);
      }
    }

    /* Continue buttons */
    .reward-btn {
      margin-top:14px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .reward-btn:hover {
      background:#222832;
    }

    .modal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }

    .modal-content {
      background:#11141c;
      border:1px solid #262a36;
      padding:20px;
      border-radius:8px;
      width:400px;
    }

    .close-btn {
      margin-top:12px;
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
    }

    .close-btn:hover {
      background:#222832;
    }

    /* Enemy inspection */
    .inspect-row {
      margin:6px 0;
      font-size:14px;
      opacity:0.9;
    }

    .inspect-ability {
      padding:6px;
      margin:4px 0;
      background:#1a1d24;
      border-radius:4px;
      border:1px solid #333;
    }

    /* Equipment swap */
    .swap-slot,
    .swap-item {
      padding:8px;
      margin:6px 0;
      background:#1a1d24;
      border-radius:4px;
      border:1px solid #333;
      cursor:pointer;
    }

    .swap-slot:hover,
    .swap-item:hover {
      background:#222832;
    }

    /* HP bar animations */
    .hp-fill {
      transition: width 0.6s ease-in-out;
    }

    .damage-flash {
      animation: damageFlash 0.4s ease-out;
    }

    @keyframes damageFlash {
      0% {
        background-color: rgba(255,0,0,0.6);
      }
      100% {
        background-color: transparent;
      }
    }

    .heal-flash {
      animation: healFlash 0.4s ease-out;
    }

    @keyframes healFlash {
      0% {
        background-color: rgba(0,255,0,0.6);
      }
      100% {
        background-color: transparent;
      }
    }

    /* Ability card with icon */
    .ability-card {
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      margin:8px 0;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      position:relative;
    }

    .ability-icon {
      width:48px;
      height:48px;
      border-radius:4px;
      background:#000;
      border:1px solid #444;
      object-fit:cover;
    }

    /* Tooltip */
    .ability-tooltip {
      display:none;
      position:absolute;
      left:60px;
      top:0;
      background:#11141c;
      border:1px solid #262a36;
      padding:10px;
      border-radius:6px;
      width:260px;
      z-index:1000;
      font-size:13px;
    }

    .ability-card:hover .ability-tooltip {
      display:block;
    }

    /* Cooldown overlay */
    .cooldown-overlay {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      color:#fff;
      font-size:20px;
      display:flex;
      justify-content:center;
      align-items:center;
      border-radius:6px;
      pointer-events:none;
    }

    /* Disabled ability */
    .ability-disabled {
      opacity:0.4;
      pointer-events:none;
    }

    /* Ultimate charge bar container */
    .ult-bar {
      margin-top:8px;
      height:12px;
      background:#333;
      border-radius:6px;
      overflow:hidden;
      position:relative;
    }

    /* Fill */
    .ult-fill {
      height:100%;
      background:#ffbf5f;
      width:0%;
      transition: width 0.6s ease-in-out;
    }

    /* Glow when ready */
    .ult-ready-glow {
      animation: ultGlow 1.2s infinite ease-in-out;
    }

    @keyframes ultGlow {
      0% {
        box-shadow: 0 0 6px rgba(255,191,95,0.4);
      }
      50% {
        box-shadow: 0 0 12px rgba(255,191,95,0.9);
      }
      100% {
        box-shadow: 0 0 6px rgba(255,191,95,0.4);
      }
    }

    /* Pulse when used */
    .ult-pulse {
      animation: ultPulse 0.5s ease-out;
    }

    @keyframes ultPulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.15);
      }
      100% {
        transform: scale(1);
      }
    }

    /* Portrait frame */
    .portrait-frame {
      width:140px;
      height:140px;
      border-radius:8px;
      overflow:hidden;
      border:2px solid #444;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      margin:0 auto;
      position:relative;
    }

    /* Portrait image */
    .portrait-img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Rarity glow */
    .portrait-common {
      box-shadow:0 0 6px #bfbfbf55;
    }
    .portrait-uncommon {
      box-shadow:0 0 8px #7fff7f88;
    }
    .portrait-rare {
      box-shadow:0 0 8px #7fcfff88;
    }
    .portrait-epic {
      box-shadow:0 0 8px #c77fff88;
    }
    .portrait-legendary {
      box-shadow:0 0 10px #ffbf5faa;
    }

    /* Cinematic intro panel */
    .cinematic-intro {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:2000;
      animation: introFadeIn 0.6s ease-out;
    }

    @keyframes introFadeIn {
      from {
        opacity:0;
      }
      to {
        opacity:1;
      }
    }

    .cinematic-content {
      text-align:center;
      animation: introPop 0.5s ease-out;
    }

    @keyframes introPop {
      0% {
        transform:scale(0.8); opacity:0;
      }
      100% {
        transform:scale(1); opacity:1;
      }
    }

    .vs-text {
      font-size:48px;
      font-weight:700;
      color:#ffbf5f;
      margin-top:20px;
      text-shadow:0 0 12px #ffbf5f;
    }

    /* Roar shake */
    .roar-shake {
      animation: roarShake 0.5s ease-in-out;
    }

    @keyframes roarShake {
      0% {
        transform:translateX(0);
      }
      20% {
        transform:translateX(-8px);
      }
      40% {
        transform:translateX(8px);
      }
      60% {
        transform:translateX(-6px);
      }
      80% {
        transform:translateX(6px);
      }
      100% {
        transform:translateX(0);
      }
    }

    /* Screen shake */
    .screen-shake {
      animation: screenShake 0.4s ease-in-out;
    }

    @keyframes screenShake {
      0% {
        transform:translate(0,0);
      }
      20% {
        transform:translate(-6px, 4px);
      }
      40% {
        transform:translate(6px, -4px);
      }
      60% {
        transform:translate(-4px, 2px);
      }
      80% {
        transform:translate(4px, -2px);
      }
      100% {
        transform:translate(0,0);
      }
    }

    /* Crit flash */
    .crit-flash {
      animation: critFlash 0.4s ease-out;
    }

    @keyframes critFlash {
      0% {
        box-shadow:0 0 12px rgba(255,255,0,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,255,0,0);
      }
    }

    /* Elemental pulses */
    .fire-pulse {
      animation: firePulse 0.5s ease-out;
    }

    @keyframes firePulse {
      0% {
        box-shadow:0 0 12px rgba(255,80,0,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,80,0,0);
      }
    }

    .ice-pulse {
      animation: icePulse 0.5s ease-out;
    }

    @keyframes icePulse {
      0% {
        box-shadow:0 0 12px rgba(120,200,255,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(120,200,255,0);
      }
    }

    .lightning-pulse {
      animation: lightningPulse 0.5s ease-out;
    }

    @keyframes lightningPulse {
      0% {
        box-shadow:0 0 12px rgba(255,255,120,0.9);
      }
      100% {
        box-shadow:0 0 0 rgba(255,255,120,0);
      }
    }

    /* DOT/HOT tick flash */
    .dot-tick {
      animation: dotTick 0.4s ease-out;
    }

    @keyframes dotTick {
      0% {
        background-color:rgba(255,80,0,0.4);
      }
      100% {
        background-color:transparent;
      }
    }

    .hot-tick {
      animation: hotTick 0.4s ease-out;
    }
    @keyframes hotTick {
      0% {
        background-color:rgba(80,255,80,0.4);
      }
      100% {
        background-color:transparent;
      }
    }

    /* Modifier row */
    .modifier-row {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
      padding:8px;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      font-size:14px;
    }
    /* Modifier icon */
    .modifier-icon {
      width:32px;
      height:32px;
      object-fit:contain;
    }
    /* Modifier label */
    .modifier-label {
      opacity:0.9;
    }
    /* Modifier container */
    .modifier-box {
      margin-top:16px;
    }
    /* Modal backdrop */
    .item-modal {
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.65);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:9999;
      transition:0.2s;
    }

    .item-modal.hidden {
      opacity:0;
      pointer-events:none;
    }

    /* Modal window */
    .item-modal-content {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:10px;
      padding:20px;
      width:420px;
      max-height:80vh;
      overflow-y:auto;
      animation:popIn 0.25s ease-out;
    }

    @keyframes popIn {
      from { transform:scale(0.85); opacity:0; }
      to   { transform:scale(1); opacity:1; }
    }

    .item-entry {
      background:#1a1d24;
      border:1px solid #333;
      border-radius:6px;
      padding:12px;
      margin:10px 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:0.15s;
    }

    .item-entry:hover {
      background:#222832;
    }

    .item-info {
      max-width:70%;
    }

    .item-name {
      font-weight:600;
      font-size:15px;
    }

    .item-desc {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-qty {
      opacity:0.8;
      font-size:13px;
      margin-top:4px;
    }

    .item-actions button {
      padding:6px 10px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      font-size:12px;
    }

    .item-actions button:hover {
      background:#222832;
    }

    /* Rarity colors */
    .rarity-common {
      color:#bfbfbf;
    }
    .rarity-uncommon {
      color:#7fff7f;
    }
    .rarity-rare {
      color:#7fcfff;
    }
    .rarity-epic {
      color:#c77fff;
    }
    .rarity-legendary {
      color:#ffbf5f;
    }

  </style>
</head>
<body>

  <!-- ============================
        HEADER / USER DISPLAY
  ============================= -->
  <div id="usernameDisplay" class="username-display"></div>

  <!-- ============================
        REGION SELECTOR + START
  ============================= -->
  <div class="fight-controls">
    <label for="regionSelect">Region:</label>
    <select id="regionSelect">
      <option value="forest">Forest</option>
      <option value="mountains">Mountains</option>
      <option value="swamp">Swamp</option>
      <option value="desert">Desert</option>
    </select>

    <button id="startFightBtn" class="btn start-btn">Start Fight</button>
  </div>

  <!-- ============================
        PLAYER / ENEMY HUD
  ============================= -->
  <div id="combatHud" class="combat-hud">
    <div id="playerPanel" class="hud-panel player-panel">
      <div class="hud-header">
        <span id="playerName" class="hud-name">Player</span>
        <span id="playerLevel" class="hud-level">Lv 1</span>
      </div>

      <div class="hud-bar hp-bar">
        <div id="playerHpFill" class="bar-fill"></div>
        <span id="playerHpText" class="bar-text">HP 0 / 0</span>
      </div>

      <div class="hud-bar mana-bar">
        <div id="playerManaFill" class="bar-fill"></div>
        <span id="playerManaText" class="bar-text">MP 0 / 0</span>
      </div>

      <div class="hud-bar ult-bar">
        <div id="playerUltFill" class="bar-fill"></div>
        <span id="playerUltText" class="bar-text">ULT 0%</span>
      </div>
    </div>

    <div id="enemyPanel" class="hud-panel enemy-panel">
      <div class="hud-header">
        <span id="enemyName" class="hud-name">Enemy</span>
        <span id="enemyLevel" class="hud-level">Lv 1</span>
      </div>

      <div class="hud-bar hp-bar">
        <div id="enemyHpFill" class="bar-fill"></div>
        <span id="enemyHpText" class="bar-text">HP 0 / 0</span>
      </div>

      <div class="hud-bar mana-bar">
        <div id="enemyManaFill" class="bar-fill"></div>
        <span id="enemyManaText" class="bar-text">MP 0 / 0</span>
      </div>

      <button id="inspectEnemyBtn" class="btn inspect-btn">Inspect</button>
    </div>
  </div>

  <!-- ============================
        COMBAT LOG
  ============================= -->
  <div id="combatLog" class="combat-log"></div>

  <!-- ============================
        ACTION PANEL (PLAYER TURN)
  ============================= -->
  <div id="actionPanel" class="action-panel" style="display:none;">
    <button id="basicAttackBtn" class="btn action-btn">Basic Attack</button>
    <button id="openAbilitiesBtn" class="btn action-btn">Abilities</button>
    <button id="ultimateBtn" class="btn action-btn">Ultimate</button>
    <button id="openItemBtn" class="btn action-btn">Item</button>
    <button id="fleeBtn" class="btn action-btn">Flee</button>
    <button id="autoBtn" class="btn action-btn">Auto</button>
  </div>

  <!-- ============================
        ABILITY PANEL
  ============================= -->
  <div id="abilityPanel" class="ability-panel" style="display:none;">
    <h3>Choose Ability</h3>
    <div id="abilityList"></div>
    <button class="btn close-btn"
            onclick="document.getElementById('abilityPanel').style.display='none'">
      Close
    </button>
  </div>

  <!-- ============================
        ITEM MODAL
  ============================= -->
  <div id="itemModal" class="item-modal hidden">
    <div class="item-modal-content">
      <h2>Use Item</h2>
      <div id="itemList">Loading...</div>
      <button class="btn close-btn"
              onclick="document.getElementById('itemModal').classList.add('hidden')">
        Close
      </button>
    </div>
  </div>

  <!-- ============================
        CINEMATIC INTRO
  ============================= -->
  <div id="cinematicIntro" class="cinematic-intro" style="display:none;">
    <div class="cinematic-content">
      <div id="cinematicPortrait" class="portrait-frame"></div>
      <div id="cinematicName" class="cinematic-name"></div>
      <div class="vs-text">VS</div>
    </div>
  </div>

  <!-- ============================
        RESUME PREVIOUS FIGHT MODAL
  ============================= -->
  <div id="resumeModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Resume Previous Fight?</h2>
      <p>You have an unfinished battle. Would you like to continue it?</p>

      <button class="btn" onclick="resumeFight()">Resume</button>
      <button class="btn" onclick="startNewFight()">Start New Fight</button>
    </div>
  </div>

  <!-- ============================
        TURN-BASED COMBAT WIRING
  ============================= -->
  <script type="module">
    import { requireSession } from "./session-guard.js";
    import { EncounterEngine } from "./encounters.js";
    import { PlayerStorage } from "./player-storage.js";
    import { api } from "./api.js";
    import {
      buildCombatContext,
      runCombatRound as engineRunRound
    } from "./combat-engine.js";
  
    /* ============================================================
       SESSION + PLAYER + ENCOUNTER LOAD
    ============================================================ */
  
    await requireSession();
    const { local, remote, conflict, username } = window.syncState;
  
    document.getElementById("usernameDisplay").textContent =
      "Logged in as: " + username;
  
    // Choose player version
    let rawPlayer = null;
    if (conflict === "remote-only") rawPlayer = remote;
    else if (conflict === "local-only") rawPlayer = local;
    else if (conflict === "match") rawPlayer = local || remote;
    else if (conflict === "conflict") rawPlayer = remote || local;
    else rawPlayer = local || remote;
  
    if (!rawPlayer) {
      alert("No player data found.");
      window.location.href = "world-map.html";
    }
  
    // Cache locally
    PlayerStorage.save(username, rawPlayer);
  
    const encounter = EncounterEngine.loadFromSession();
    if (!encounter) {
      alert("No encounter found. Returning to map.");
      window.location.href = "world-map.html";
    }
  
    /* ============================================================
       RUNTIME ENTITIES
    ============================================================ */
  
    function resolvePlayer(raw) {
      const stats = raw.computedStatsJSON || {};
  
      const hpMax = stats.hpMax || 1;
      const manaMax = stats.manaMax || 0;
  
      const hpCurrent = Math.max(0, Math.min(raw.hpCurrent ?? hpMax, hpMax));
      const manaCurrent = Math.max(0, Math.min(raw.manaCurrent ?? manaMax, manaMax));
  
      return {
        id: raw.username,
        name: raw.username,
        level: raw.level || 1,
        profession: raw.profession,
        race: raw.race,
        subrace: raw.subrace,
  
        hpCurrent,
        hpMax,
        manaCurrent,
        manaMax,
  
        atk: stats.atk || 1,
        def: stats.def || 0,
        speed: stats.speed || 1,
  
        critChance: stats.critChance || 0.05,
        critDamageMult: stats.critDamage || 1.5,
  
        element: stats.element || null,
        statusEffects: Array.isArray(raw.playerStatusEffects)
          ? raw.playerStatusEffects
          : [],
        cooldowns: raw.cooldowns || {},
        pendingAction: null,
  
        abilities: raw.abilities || [],
        ultimate: raw.ultimate || null,
        ultimateCharge: raw.ultimateCharge || 0,
        ultimateChargeRequired: raw.ultimateChargeRequired || 100,
  
        equipment: raw.equipment || {},
        talentTree: raw.talentTree || {},
        talentPoints: raw.talentPoints || 0,
  
        inventory: raw.inventory || [],
  
        regionMetaJSON: raw.regionMetaJSON || {},
  
        isPlayer: true,
        lastAction: null,
        lastActionType: null
      };
    }
  
    function resolveEnemyForCombat(e) {
      return {
        name: e.name,
        level: e.level || 1,
        element: e.element || "neutral",
  
        hpCurrent: e.hpMax ?? e.hp ?? 1,
        hpMax: e.hpMax ?? e.hp ?? 1,
        atk: e.attack ?? e.atk ?? 1,
        def: e.defense ?? e.def ?? 0,
        speed: e.speed || 1,
  
        statusEffects: [],
        cooldowns: {},
        isPlayer: false
      };
    }
  
    /* ============================================================
       COMBAT STATE
    ============================================================ */
  
    const logBox = document.getElementById("combatLog");
    const actionPanel = document.getElementById("actionPanel");
    const abilityPanel = document.getElementById("abilityPanel");
    const itemModal = document.getElementById("itemModal");
  
    let combat = null;
    let autoBattle = false;
  
    function isDead(entity) {
      return !entity || entity.hpCurrent <= 0;
    }
  
    function checkOutcome(player, enemy) {
      if (player.hpCurrent <= 0 && enemy.hpCurrent <= 0) return "draw";
      if (player.hpCurrent <= 0) return "defeat";
      if (enemy.hpCurrent <= 0) return "victory";
      return null;
    }
  
    /* ============================================================
       LOGGING
    ============================================================ */
  
    function addLog(line) {
      const div = document.createElement("div");
      div.innerHTML = formatLog(line);
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    }
  
    function renderLogs(logs) {
      for (const line of logs) addLog(line);
    }
  
    /* ============================================================
       HUD RENDERING
    ============================================================ */
  
    function renderPanels() {
      if (!combat) return;
      renderPlayerPanel(combat.playerState);
      renderEnemyPanel(combat.enemyState);
    }
  
    function renderPlayerPanel(p) {
      if (!p) return;
  
      document.getElementById("playerName").textContent = p.name || "Player";
      document.getElementById("playerLevel").textContent = "Lv " + (p.level || 1);
  
      updateHPBar("playerHpFill", "playerHpText", p.hpCurrent, p.hpMax);
      updateManaBar("playerManaFill", "playerManaText", p.manaCurrent, p.manaMax);
      updateUltimateBar(p);
    }
  
    function renderEnemyPanel(e) {
      if (!e) return;
  
      document.getElementById("enemyName").textContent = e.name || "Enemy";
      document.getElementById("enemyLevel").textContent = "Lv " + (e.level || 1);
  
      updateHPBar("enemyHpFill", "enemyHpText", e.hpCurrent, e.hpMax);
      updateManaBar("enemyManaFill", "enemyManaText", e.manaCurrent || 0, e.manaMax || 0);
    }
  
    function updateHPBar(fillId, textId, current, max) {
      const fill = document.getElementById(fillId);
      const text = document.getElementById(textId);
  
      current = current || 0;
      max = max || 1;
  
      const pct = Math.max(0, Math.min(100, (current / max) * 100));
  
      if (fill) fill.style.width = pct + "%";
      if (text) text.textContent = `HP ${current} / ${max}`;
    }
  
    function updateManaBar(fillId, textId, current, max) {
      const fill = document.getElementById(fillId);
      const text = document.getElementById(textId);
  
      current = current || 0;
      max = max || 0;
  
      const pct = max > 0 ? Math.max(0, Math.min(100, (current / max) * 100)) : 0;
  
      if (fill) fill.style.width = pct + "%";
      if (text) text.textContent = `MP ${current} / ${max}`;
    }
  
    function updateUltimateBar(playerState) {
      const fill = document.getElementById("playerUltFill");
      const text = document.getElementById("playerUltText");
  
      const charge = playerState.ultimateCharge || 0;
      const required = playerState.ultimateChargeRequired || 100;
  
      const pct = Math.max(0, Math.min(100, (charge / required) * 100));
  
      if (fill) fill.style.width = pct + "%";
      if (text) text.textContent = `ULT ${Math.round(pct)}%`;
    }
  
    /* ============================================================
       START FIGHT
    ============================================================ */
  
    async function beginFight() {
      logBox.innerHTML = "";
  
      const playerState = resolvePlayer(rawPlayer);
      const enemyState = resolveEnemyForCombat(encounter.enemy);
  
      const context = buildCombatContext(
        encounter.region,
        encounter.biome,
        encounter.weather,
        encounter.event,
        playerState,
        enemyState
      );
  
      combat = {
        playerState,
        enemyState,
        context
      };
  
      const introLogs = [];
      introLogs.push(`You encounter **${enemyState.name}** in the ${encounter.region}!`);
      if (encounter.hazard) {
        introLogs.push(`The area is hazardous: ${encounter.hazard}`);
      }
  
      renderLogs(introLogs);
      renderPanels();
  
      const outcome = checkOutcome(playerState, enemyState);
      if (outcome) {
        addLog("Combat ended immediately: " + outcome);
        await finalizeRewards(outcome);
        endCombat(outcome);
        return;
      }
  
      showCinematicIntro(enemyState);
      showActionPanel();
    }
  
    /* ============================================================
       RUN ROUND (WRAPPER AROUND combat-engine)
    ============================================================ */
  
    async function runRound(playerAction) {
      hideActionPanel();
  
      const logs = [];
      const result = engineRunRound(
        combat.playerState,
        combat.enemyState,
        combat.context,
        playerAction,
        logs
      );
  
      combat.playerState = result.player;
      combat.enemyState = result.enemy;
      combat.context = result.context;
  
      renderLogs(result.logs || logs);
      renderPanels();
  
      const outcome = checkOutcome(combat.playerState, combat.enemyState);
      if (outcome) {
        addLog("Combat ended: " + outcome.toUpperCase());
        await finalizeRewards(outcome);
        endCombat(outcome);
        return;
      }
  
      if (autoBattle) {
        autoLoop();
      } else {
        showActionPanel();
      }
    }
  
    /* ============================================================
       FINALIZE REWARDS (LOCAL + KV)
    ============================================================ */
  
    async function finalizeRewards(outcome) {
      if (outcome !== "victory") return;
  
      const p = PlayerStorage.load(username);
      if (!p) return;
  
      // Placeholder rewards — tune later
      p.xp = (p.xp || 0) + 10;
      p.gold = (p.gold || 0) + 5;
  
      PlayerStorage.save(username, p);
      await api.savePlayer(username, p); // autoSync inside api
    }
  
    /* ============================================================
       PLAYER ACTIONS
    ============================================================ */
  
    async function chooseBasicAttack() {
      await runRound({ type: "basic" });
    }
  
    async function chooseAbility(key) {
      closeAbilityMenu();
      await runRound({ type: "ability", ability: { key } });
    }
  
    async function chooseUltimate() {
      const p = combat.playerState;
      if ((p.ultimateCharge || 0) < (p.ultimateChargeRequired || 100)) {
        addLog("Ultimate not ready!");
        return;
      }
      await runRound({ type: "ability", ability: p.ultimate, isUltimate: true });
    }
  
    async function chooseItem(itemId) {
      closeItemModal();
      await runRound({ type: "item", itemId });
    }
  
    async function chooseFlee() {
      await runRound({ type: "flee" });
    }
  
    /* ============================================================
       AUTO-BATTLE
    ============================================================ */
  
    async function toggleAutoBattle() {
      autoBattle = !autoBattle;
      addLog("Auto-battle: " + (autoBattle ? "ON" : "OFF"));
      if (autoBattle) autoLoop();
    }
  
    async function autoLoop() {
      if (!autoBattle) return;
      const action = pickAutoAction(combat.playerState);
      await runRound(action);
    }
  
    function pickAutoAction() {
      return { type: "basic" };
    }
  
    /* ============================================================
       ITEM SYSTEM
    ============================================================ */
  
    function openItemModal() {
      itemModal.classList.remove("hidden");
      loadCombatItems();
    }
  
    function closeItemModal() {
      itemModal.classList.add("hidden");
    }
  
    function loadCombatItems() {
      const list = document.getElementById("itemList");
      list.innerHTML = "";
  
      const inv = combat.playerState.inventory || [];
  
      if (!inv.length) {
        list.innerHTML = "<div>No usable items.</div>";
        return;
      }
  
      inv.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "btn item-btn";
        btn.textContent = `${item.name} (${item.qty ?? item.quantity ?? 1})`;
        btn.onclick = () => chooseItem(item.id);
        list.appendChild(btn);
      });
    }
  
    /* ============================================================
       ABILITY MENU
    ============================================================ */
  
    function openAbilityMenu() {
      const list = document.getElementById("abilityList");
      list.innerHTML = "";
  
      const abilities = combat.playerState.abilities || [];
  
      abilities.forEach(a => {
        const btn = document.createElement("button");
        btn.className = "btn ability-btn";
        btn.textContent = a.name;
        btn.onclick = () => chooseAbility(a.key);
        list.appendChild(btn);
      });
  
      abilityPanel.style.display = "block";
    }
  
    function closeAbilityMenu() {
      abilityPanel.style.display = "none";
    }
  
    /* ============================================================
       VFX
    ============================================================ */
  
    function screenShake(intensity = 5, duration = 150) {
      const root = document.body;
      root.classList.add("screen-shake");
      setTimeout(() => root.classList.remove("screen-shake"), duration);
    }
  
    function critFlash() {
      logBox.classList.add("crit-flash");
      setTimeout(() => logBox.classList.remove("crit-flash"), 200);
    }
  
    function elementalPulse(element) {
      const hud = document.getElementById("combatHud");
      hud.classList.add(`pulse-${element}`);
      setTimeout(() => hud.classList.remove(`pulse-${element}`), 300);
    }
  
    function applyVFX(event) {
      if (!event || !event.type) return;
  
      switch (event.type) {
        case "crit":
          critFlash();
          break;
        case "big_hit":
          screenShake();
          break;
        case "elemental_hit":
          if (event.payload?.element) elementalPulse(event.payload.element);
          break;
      }
    }
  
    /* ============================================================
       CINEMATIC INTRO
    ============================================================ */
  
    function showCinematicIntro(enemy) {
      const intro = document.getElementById("cinematicIntro");
      const name = document.getElementById("cinematicName");
  
      name.textContent = enemy.name || "Unknown Foe";
  
      intro.style.display = "flex";
      intro.style.opacity = 0;
  
      setTimeout(() => {
        intro.style.opacity = 1;
      }, 50);
  
      setTimeout(() => {
        intro.style.opacity = 0;
        setTimeout(() => (intro.style.display = "none"), 300);
      }, 2000);
    }
  
    /* ============================================================
       INSPECT ENEMY
    ============================================================ */
  
    function inspectEnemy() {
      const e = combat.enemyState;
      alert(
        `${e.name}\n` +
        `Level: ${e.level}\n` +
        `HP: ${e.hpCurrent}/${e.hpMax}\n` +
        `ATK: ${e.atk}\n` +
        `DEF: ${e.def}\n` +
        `Element: ${e.element}`
      );
    }
  
    /* ============================================================
       END COMBAT / REWARDS
    ============================================================ */
  
    function endCombat(outcome) {
      hideActionPanel();
  
      const rewardPanel = document.createElement("div");
      rewardPanel.className = "reward-panel";
  
      let lootHtml = "";
  
      if (outcome === "victory") {
        lootHtml = `
          <h2>Victory!</h2>
          <p>You defeated ${combat.enemyState.name}!</p>
          <div class="loot-box">Loot goes here…</div>
          <button class="btn" onclick="continueExploring()">Continue Exploring</button>
          <button class="btn" onclick="goToMap()">Return to Map</button>
        `;
      } else if (outcome === "defeat") {
        lootHtml = `
          <h2>Defeat…</h2>
          <p>You were defeated by ${combat.enemyState.name}.</p>
          <button class="btn" onclick="goToMap()">Return to Map</button>
        `;
      } else {
        lootHtml = `
          <h2>Battle Over</h2>
          <button class="btn" onclick="goToMap()">Return to Map</button>
        `;
      }
  
      rewardPanel.innerHTML = lootHtml;
      document.body.appendChild(rewardPanel);
    }
  
    function continueExploring() {
      window.location.href = "world-map.html";
    }
  
    function goToMap() {
      window.location.href = "world-map.html";
    }
  
    /* ============================================================
       HELPERS
    ============================================================ */
  
    function format(num) {
      return Number(num).toLocaleString();
    }
  
    function formatLog(text) {
      return text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    }
  
    function showActionPanel() {
      actionPanel.style.display = "block";
    }
  
    function hideActionPanel() {
      actionPanel.style.display = "none";
    }
  
    /* ============================================================
       BUTTON BINDINGS
    ============================================================ */
  
    document.getElementById("startFightBtn").onclick = beginFight;
    document.getElementById("basicAttackBtn").onclick = chooseBasicAttack;
    document.getElementById("ultimateBtn").onclick = chooseUltimate;
    document.getElementById("fleeBtn").onclick = chooseFlee;
    document.getElementById("autoBtn").onclick = toggleAutoBattle;
    document.getElementById("openItemBtn").onclick = openItemModal;
    document.getElementById("openAbilitiesBtn").onclick = openAbilityMenu;
    document.getElementById("inspectEnemyBtn").onclick = inspectEnemy;
  
    window.chooseAbility = chooseAbility;
    window.chooseItem = chooseItem;
    window.continueExploring = continueExploring;
    window.goToMap = goToMap;
  </script>

</body>
</html>
