<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin – Economy Controls</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:32px;
      max-width:800px;
      margin:auto;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #adminDisplay {
      opacity:0.8;
      margin-bottom:20px;
    }

    .section {
      background:#11141c;
      border:1px solid #262a36;
      border-radius:8px;
      padding:18px;
      margin-bottom:20px;
    }

    .section h2 {
      margin-top:0;
      color:#9af7ff;
      font-size:18px;
    }

    .field-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:8px 0;
      font-size:14px;
      gap:12px;
    }

    .field-row label {
      flex:1;
      opacity:0.9;
    }

    .field-row input {
      flex:0.8;
    }

    input, select, button {
      background:#1a1d24;
      color:#eee;
      border:1px solid #444;
      padding:8px;
      border-radius:4px;
      font-size:14px;
    }

    button {
      cursor:pointer;
    }

    button:hover {
      background:#222832;
    }

    .btn-primary {
      margin-top:12px;
      width:100%;
      text-align:center;
    }

    .btn-nav {
      margin-top:16px;
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
    }

    .btn-nav:hover {
      background:#222832;
    }

    #statusMessage {
      margin-top:10px;
      font-size:13px;
      opacity:0.85;
    }
  </style>
</head>

<body>

  <h1>Economy Controls</h1>
  <div id="adminDisplay"></div>

  <div class="section">
    <h2>Global Multipliers</h2>

    <div class="field-row">
      <label for="xpMultiplier">XP Multiplier</label>
      <input id="xpMultiplier" type="number" step="0.1" placeholder="1.0">
    </div>

    <div class="field-row">
      <label for="goldMultiplier">Gold Multiplier</label>
      <input id="goldMultiplier" type="number" step="0.1" placeholder="1.0">
    </div>

    <div class="field-row">
      <label for="dropRateMultiplier">Drop Rate Multiplier</label>
      <input id="dropRateMultiplier" type="number" step="0.1" placeholder="1.0">
    </div>

    <button class="btn-primary" onclick="saveEconomy()">Save Economy Settings</button>
    <div id="statusMessage"></div>
  </div>

  <div class="section">
    <h2>Shop & Refresh</h2>

    <div class="field-row">
      <label for="shopPriceScale">Shop Price Scale</label>
      <input id="shopPriceScale" type="number" step="0.1" placeholder="1.0">
    </div>

    <div class="field-row">
      <label for="dailyRefreshHour">Daily Refresh Hour (0–23, server time)</label>
      <input id="dailyRefreshHour" type="number" min="0" max="23" placeholder="0">
    </div>

    <button class="btn-primary" onclick="saveShop()">Save Shop Settings</button>
  </div>

  <button class="btn-nav" onclick="goAdmin()">Back to Admin Dashboard</button>

  <script>
    const admin = sessionStorage.getItem("twitch_username");
    document.getElementById("adminDisplay").textContent =
      admin ? "Admin: " + admin : "Not logged in";

    async function loadEconomy() {
      try {
        const res = await fetch("/api/admin/economy", { cache:"no-store" });
        if (!res.ok) return;

        const data = await res.json();

        document.getElementById("xpMultiplier").value = data.xpMultiplier ?? 1;
        document.getElementById("goldMultiplier").value = data.goldMultiplier ?? 1;
        document.getElementById("dropRateMultiplier").value = data.dropRateMultiplier ?? 1;
        document.getElementById("shopPriceScale").value = data.shopPriceScale ?? 1;
        document.getElementById("dailyRefreshHour").value = data.dailyRefreshHour ?? 0;
      } catch {
        // silent; page still usable
      }
    }

    async function saveEconomy() {
      const payload = {
        admin,
        xpMultiplier: Number(document.getElementById("xpMultiplier").value),
        goldMultiplier: Number(document.getElementById("goldMultiplier").value),
        dropRateMultiplier: Number(document.getElementById("dropRateMultiplier").value),
        shopPriceScale: Number(document.getElementById("shopPriceScale").value),
        dailyRefreshHour: Number(document.getElementById("dailyRefreshHour").value)
      };

      try {
        const res = await fetch("/api/admin/economy/update", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payload)
        });

        const data = await res.json();
        document.getElementById("statusMessage").textContent =
          data.message || "Economy settings saved.";
      } catch (err) {
        document.getElementById("statusMessage").textContent =
          "Error saving economy: " + err.message;
      }
    }

    async function saveShop() {
      const payload = {
        admin,
        shopPriceScale: Number(document.getElementById("shopPriceScale").value),
        dailyRefreshHour: Number(document.getElementById("dailyRefreshHour").value)
      };

      try {
        const res = await fetch("/api/admin/economy/shop", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(payload)
        });

        const data = await res.json();
        document.getElementById("statusMessage").textContent =
          data.message || "Shop settings saved.";
      } catch (err) {
        document.getElementById("statusMessage").textContent =
          "Error saving shop settings: " + err.message;
      }
    }

    function goAdmin() {
      window.location.href = "admin-dashboard.html";
    }

    async function giftGold() {
      const target = document.getElementById("targetUser").value.trim();
      const amount = Number(document.getElementById("goldAmount").value);
      const status = document.getElementById("statusMessage");
    
      const res = await fetch("/api/admin/gold/gift", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ admin, target, amount })
      });
    
      const data = await res.json();
      status.textContent = data.message || "Gold gifted.";
    }
    
    async function giftExp() {
      const target = document.getElementById("targetUser").value.trim();
      const amount = Number(document.getElementById("expAmount").value);
      const status = document.getElementById("statusMessage");
    
      const res = await fetch("/api/admin/exp/gift", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ admin, target, amount })
      });
    
      const data = await res.json();
      status.textContent = data.message || "EXP gifted.";
    }
    
    async function grantItem() {
      const target = document.getElementById("targetUser").value.trim();
      const itemKey = document.getElementById("itemKey").value.trim();
      const quantity = Number(document.getElementById("itemQty").value);
      const status = document.getElementById("statusMessage");
    
      const res = await fetch("/api/admin/items/grant", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ admin, target, itemKey, quantity })
      });
    
      const data = await res.json();
      status.textContent = data.message || "Item granted.";
    }

    loadEconomy();
  </script>

</body>
</html>
