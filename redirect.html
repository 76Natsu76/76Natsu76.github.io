<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Redirect</title>
</head>
<body>
  <p>Completing login...</p>

<script>
(async function () {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const error = params.get("error");

  if (error) {
    console.error("Twitch OAuth error:", error);
    document.body.innerHTML = "<p>Login failed: " + error + "</p>";
    return;
  }

  if (!code) {
    document.body.innerHTML = "<p>No authorization code found.</p>";
    return;
  }

  const codeVerifier = sessionStorage.getItem("pkce_code_verifier");
  if (!codeVerifier) {
    document.body.innerHTML = "<p>Missing PKCE code verifier.</p>";
    return;
  }

  const appUrl = "https://script.google.com/macros/s/AKfycbyk-fbDyRiLscc7JFjayabaY2h7G98NJkQ44prCiUJEAJI-_DtqKhM80rwB1GozmwKL/exec";

  try {
    const res = await fetch(appUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "exchange",
        code: code,
        code_verifier: codeVerifier
      })
    });

    const json = await res.json();
    if (json.access_token) {
      window.location.href = appUrl + "?token=" + encodeURIComponent(json.access_token);
    } else {
      console.error("Token exchange failed:", json);
      document.body.innerHTML = "<p>Token exchange failed.</p>";
    }
  } catch (err) {
    console.error("Error calling Apps Script:", err);
    document.body.innerHTML = "<p>Error completing login.</p>";
  }
})();
</script>
</body>
</html>
