<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Completing Login…</title>

  <style>
    body {
      background: #0d0d0d;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    #debug {
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 14px;
      color: #7fffd4;
    }
  </style>
</head>

<body>

  <h2>Completing Twitch Login…</h2>
  <div id="debug"></div>

  <script>
    const CLIENT_ID = "5xu3qolkx8ym1altj0c2ecvu9tw6u9";
    const REDIRECT_URI = "https://76natsu76.github.io/redirect.html";

    const log = msg => {
      console.log(msg);
      document.getElementById("debug").textContent += msg + "\n";
    };

    // Read Twitch OAuth parameters
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");

    log("Received code: " + code);
    log("Received state: " + state);

    if (!code) {
      log("No code received — cannot continue.");
      throw new Error("Missing code");
    }

    // Validate state
    const savedState = sessionStorage.getItem("oauth_state");
    if (savedState && state !== savedState) {
      log("State mismatch — aborting.");
      throw new Error("State mismatch");
    }

    // PKCE verifier
    const codeVerifier = sessionStorage.getItem("pkce_verifier");
    if (!codeVerifier) {
      log("Missing PKCE verifier.");
      throw new Error("Missing PKCE verifier");
    }

    async function exchangeCode() {
      log("Exchanging code for token…");

      const tokenUrl = "https://id.twitch.tv/oauth2/token";

      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: "authorization_code",
        redirect_uri: REDIRECT_URI,
        code: code,
        code_verifier: codeVerifier
      });

      const res = await fetch(tokenUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      const tokenData = await res.json();
      log("Token response: " + JSON.stringify(tokenData));

      if (!tokenData.access_token) {
        log("Token exchange failed.");
        return;
      }

      const accessToken = tokenData.access_token;

      // Fetch user info
      log("Fetching Twitch user info…");

      const userRes = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Client-Id": CLIENT_ID
        }
      });

      const userData = await userRes.json();
      log("User response: " + JSON.stringify(userData));

      const user = userData.data?.[0];
      if (!user) {
        log("Failed to fetch user info.");
        return;
      }

      // Store identity
      sessionStorage.setItem("twitch_access_token", accessToken);
      sessionStorage.setItem("twitch_user_id", user.id);
      sessionStorage.setItem("twitch_username", user.login);

      log("Login successful — redirecting to landing…");

      window.location.href = "https://76natsu76.github.io/landing.html";
    }

    exchangeCode();
  </script>

</body>
</html>
