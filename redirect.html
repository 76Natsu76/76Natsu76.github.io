<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Login Redirect</title>
  <style>
    body {
      background: #0d0d0d;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
  </style>
</head>

<body>
  <h2>Completing Twitch Login…</h2>
  <pre id="log"></pre>

  <script type="module">
    import { PlayerStorage } from "./player-storage.js";

    const logBox = document.getElementById("log");
    function log(msg) {
      console.log(msg);
      logBox.textContent += msg + "\n";
    }

    // Extract URL params
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");
    const error = params.get("error");

    if (error) {
      log("Error: " + error);
      throw new Error(error);
    }

    log("Received code: " + code);
    log("Received state: " + state);

    const savedState = sessionStorage.getItem("oauth_state");
    if (state !== savedState) {
      log("State mismatch!");
      throw new Error("State mismatch");
    }

    const codeVerifier = sessionStorage.getItem("pkce_verifier");

    async function exchangeCode() {
      log("Exchanging code for token…");

      const body = new URLSearchParams({
        client_id: "j58ocpqo1vtbl730atkdn0jtpjy8z3",
        grant_type: "authorization_code",
        redirect_uri: "https://76natsu76.github.io/redirect.html",
        code: code,
        code_verifier: codeVerifier
      });

      const res = await fetch("https://id.twitch.tv/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      const json = await res.json();
      log("Token response: " + JSON.stringify(json));

      if (!json.access_token) {
        log("Token exchange failed.");
        return;
      }

      sessionStorage.setItem("twitch_access_token", json.access_token);

      // Fetch user info
      const userRes = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
          "Authorization": "Bearer " + json.access_token,
          "Client-Id": "5xu3qolkx8ym1altj0c2ecvu9tw6u9"
        }
      });

      const userJson = await userRes.json();
      const user = userJson.data[0];

      sessionStorage.setItem("twitch_username", user.login);
      sessionStorage.setItem("twitch_user_id", user.id);

      // Load or create player locally
      const player = PlayerStorage.load(user.login);
      sessionStorage.setItem("player", JSON.stringify(player));

      window.location.href = "landing.html";
    }

    exchangeCode();
  </script>
</body>
</html>
