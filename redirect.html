<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twitch Redirect (DEBUG)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    pre { background: #eee; padding: 10px; }
  </style>
</head>
<body>
  <h2>Redirect Debug</h2>
  <p>This page is receiving Twitch's redirect...</p>
  <pre id="log"></pre>

<script>
function log(msg) {
  console.log(msg);
  document.getElementById("log").textContent += msg + "\n";
}

(async function () {
  log("=== redirect.html DEBUG ===");

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const error = params.get("error");

  log("Incoming code: " + code);
  log("Incoming error: " + error);

  if (error) {
    log("OAuth error: " + error);
    return;
  }

  if (!code) {
    log("No ?code found in URL — Twitch never redirected properly.");
    return;
  }

  const codeVerifier = sessionStorage.getItem("pkce_code_verifier");
  log("Loaded code_verifier: " + codeVerifier);

  if (!codeVerifier) {
    log("Missing PKCE code_verifier.");
    return;
  }

  const appUrl = "https://script.google.com/macros/s/AKfycbyk-fbDyRiLscc7JFjayabaY2h7G98NJkQ44prCiUJEAJI-_DtqKhM80rwB1GozmwKL/exec";

  log("Sending POST to Apps Script...");

  let res;
  try {
    res = await fetch(appUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        action: "exchange",
        code: code,
        code_verifier: codeVerifier
      })
    });
  } catch (err) {
    log("Fetch error: " + err);
    return;
  }

  const json = await res.json();
  log("Apps Script response: " + JSON.stringify(json));

  if (json.access_token) {
    log("SUCCESS — redirecting with token...");
    window.location.href = appUrl + "?token=" + encodeURIComponent(json.access_token);
  } else {
    log("Token exchange failed.");
  }
  const returnedState = params.get("state");
  const storedState = sessionStorage.getItem("pkce_state");
  
  if (!returnedState || returnedState !== storedState) {
    log("State mismatch — possible CSRF attack.");
    return;
  }
})();
</script>
</body>
</html>
