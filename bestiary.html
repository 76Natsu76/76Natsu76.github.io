<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bestiary</title>

  <style>
    body {
      background: #0d0f14;
      color: #e8e8e8;
      font-family: system-ui, sans-serif;
      padding: 24px;
    }

    h1 {
      color: #7fffd4;
      margin-bottom: 4px;
    }

    #filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    select, input {
      padding: 6px;
      background: #1a1d24;
      border: 1px solid #333;
      color: #eee;
      border-radius: 4px;
    }

    .enemy-card {
      background: #11141c;
      border: 1px solid #262a36;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 16px;
    }

    .enemy-card img {
      width: 96px;
      height: 96px;
      border-radius: 6px;
      border: 1px solid #333;
      object-fit: cover;
    }

    .enemy-info h2 {
      margin: 0;
      color: #9af7ff;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      background: #1a1d24;
      border: 1px solid #333;
      border-radius: 4px;
      margin-right: 4px;
      font-size: 12px;
    }
  </style>
</head>

<body>

  <h1>Bestiary</h1>

  <div id="filters">
    <select id="regionFilter">
      <option value="">All Regions</option>
    </select>

    <select id="biomeFilter">
      <option value="">All Biomes</option>
    </select>

    <select id="familyFilter">
      <option value="">All Families</option>
    </select>

    <select id="rarityFilter">
      <option value="">All Rarities</option>
      <option>Common</option>
      <option>Uncommon</option>
      <option>Rare</option>
      <option>Epic</option>
      <option>Elite</option>
      <option>Mythical</option>
      <option>Legendary</option>
      <option>Ancient</option>
    </select>

    <input id="searchBox" placeholder="Search enemies...">
  </div>

  <div id="bestiaryContainer">Loading...</div>

  <button class="btn" onclick="goBack()">Back</button>

  <script type="module">
    import { requireSession } from "./session-guard.js";
    const session = requireSession();
    if (!session) return;
  
    import { WORLD_DATA } from "./world-data.js";
    import { BIOMES } from "./biomes.js";
    import { REGION_TO_BIOME } from "./region-to-biome.js";
    import { EnemyRegistry } from "./enemy-registry.js";
    import enemyRegions from "./enemy-regions.json" assert { type: "json" };
    import enemyTags from "./enemy-tags.json" assert { type: "json" };
  
    const container = document.getElementById("bestiaryContainer");
  
    // ------------------------------------------------------------
    // INITIALIZE FILTERS
    // ------------------------------------------------------------
    const regionFilter = document.getElementById("regionFilter");
    const biomeFilter = document.getElementById("biomeFilter");
    const familyFilter = document.getElementById("familyFilter");
    const rarityFilter = document.getElementById("rarityFilter");
    const searchBox = document.getElementById("searchBox");
  
    for (const key in WORLD_DATA.regions) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = WORLD_DATA.regions[key].name;
      regionFilter.appendChild(opt);
    }
  
    for (const key in BIOMES) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = format(key);
      biomeFilter.appendChild(opt);
    }
  
    const families = new Set(EnemyRegistry.enemies.map(e => e.family));
    families.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = format(f);
      familyFilter.appendChild(opt);
    });
  
    // ------------------------------------------------------------
    // RENDER BESTIARY
    // ------------------------------------------------------------
    function render() {
      const regionVal = regionFilter.value;
      const biomeVal = biomeFilter.value;
      const familyVal = familyFilter.value;
      const rarityVal = rarityFilter.value.toLowerCase();
      const searchVal = searchBox.value.toLowerCase();
  
      const out = [];
  
      for (const e of EnemyRegistry.enemies) {
        if (regionVal) {
          const allowed = enemyRegions[e.key];
          if (!allowed || !allowed.includes(regionVal)) continue;
        }
  
        if (biomeVal) {
          const tags = enemyTags[e.key] || [];
          if (!isEnemyAllowedInBiome(tags, biomeVal)) continue;
        }
  
        if (familyVal && e.family !== familyVal) continue;
  
        if (rarityVal && e.rarity.toLowerCase() !== rarityVal) continue;
  
        if (searchVal && !e.name.toLowerCase().includes(searchVal)) continue;
  
        const template = EnemyRegistry.buildEnemyTemplate(e.key);
  
        out.push(`
          <div class="enemy-card">
            <img src="/assets/enemies/${template.key}.png">
  
            <div class="enemy-info">
              <h2>${template.name}</h2>
  
              <div><strong>Family:</strong> ${format(template.family)}</div>
              <div><strong>Rarity:</strong> ${format(template.rarity)}</div>
  
              <div><strong>Allowed Regions:</strong> ${
                (enemyRegions[e.key] || []).map(format).join(", ") || "Any"
              }</div>
  
              <div><strong>Tags:</strong> ${
                (enemyTags[e.key] || [])
                  .map(t => `<span class="tag">${format(t)}</span>`)
                  .join("") || "None"
              }</div>
  
              <div class="event" style="margin-top:10px;">
                ${template.flavor || "No flavor text."}
              </div>
            </div>
          </div>
        `);
      }
  
      container.innerHTML = out.join("") || "<p>No enemies found.</p>";
    }
  
    function isEnemyAllowedInBiome(tags, biomeKey) {
      if (!tags.length) return true;
  
      if (tags.includes("ice")) {
        return (
          biomeKey === "tundra" ||
          biomeKey === "frozen-expanse" ||
          biomeKey === "crystalline-tundra"
        );
      }
  
      if (tags.includes("fire")) {
        return (
          biomeKey === "volcano" ||
          biomeKey === "molten-crest" ||
          biomeKey === "magma"
        );
      }
  
      if (tags.includes("void")) {
        return (
          biomeKey === "void" ||
          biomeKey === "void-wastes" ||
          biomeKey === "void-realm"
        );
      }
  
      if (tags.includes("arcane")) {
        return biomeKey === "arcane" || biomeKey === "arcane-rift";
      }
  
      if (tags.includes("astral")) {
        return biomeKey === "astral-plane" || biomeKey === "astral-nexus";
      }
  
      return true;
    }
  
    function format(str) {
      return String(str)
        .replace(/_/g, " ")
        .replace(/-/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }
  
    window.goBack = () => (window.location.href = "world-map.html");
  
    regionFilter.onchange = render;
    biomeFilter.onchange = render;
    familyFilter.onchange = render;
    rarityFilter.onchange = render;
    searchBox.oninput = render;
  
    render();
  </script>


</body>
</html>
