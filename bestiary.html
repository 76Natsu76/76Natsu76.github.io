<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bestiary</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }

    .controls {
      display:flex;
      gap:12px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }

    input, select {
      background:#1a1d24;
      color:#eee;
      border:1px solid #444;
      padding:8px;
      border-radius:4px;
      font-size:14px;
    }

    .enemy-card {
      padding:12px;
      margin:10px 0;
      background:#1a1d24;
      border-radius:6px;
      border:1px solid #333;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:0.15s;
    }

    .enemy-card:hover {
      background:#222832;
    }

    .enemy-main {
      display:flex;
      flex-direction:column;
    }

    .enemy-name {
      font-size:16px;
      font-weight:600;
      color:#9af7ff;
    }

    .enemy-sub {
      font-size:13px;
      opacity:0.8;
    }

    .rarity-pill {
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #444;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }

    .rarity-common { color:#bfbfbf; border-color:#555; }
    .rarity-uncommon { color:#7fff7f; border-color:#3a7f3a; }
    .rarity-rare { color:#7fcfff; border-color:#3a5f7f; }
    .rarity-epic { color:#c77fff; border-color:#6a3a7f; }
    .rarity-legendary { color:#ffbf5f; border-color:#7f5a2a; }

    .btn {
      margin-top:16px;
      padding:8px 12px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
    }

    .btn:hover {
      background:#222832;
    }

    .sync-indicator {
      font-size:12px;
      opacity:0.7;
      margin-bottom:8px;
    }
  </style>
</head>

<body>

  <h1>Bestiary</h1>
  <div id="usernameDisplay"></div>
  <div class="sync-indicator" id="syncIndicator">Loading enemies...</div>

  <div class="controls">
    <input id="searchBox" placeholder="Search enemies..." oninput="filterList()">
    <select id="filterFamily" onchange="filterList()">
      <option value="">All Families</option>
    </select>
    <select id="filterRarity" onchange="filterList()">
      <option value="">All Rarities</option>
    </select>
    <select id="filterRegion" onchange="filterList()">
      <option value="">All Regions</option>
    </select>
  </div>

  <div id="enemyContainer">Loading...</div>

  <button class="btn" onclick="goToMap()">World Map</button>

  <script>
    const username = sessionStorage.getItem("twitch_username");
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";

    let allEnemies = [];

    async function loadEnemies() {
      const container = document.getElementById("enemyContainer");
      const sync = document.getElementById("syncIndicator");

      try {
        sync.textContent = "Loading enemies from data/enemies.json...";
        const res = await fetch("data/enemies.json", { cache: "no-store" });

        if (!res.ok) {
          container.textContent = "Failed to load enemies.";
          sync.textContent = "Sync failed.";
          return;
        }

        allEnemies = await res.json();
        populateFilters(allEnemies);
        renderList(allEnemies);
        sync.textContent = "Enemies loaded.";
      } catch (err) {
        container.textContent = "Network error: " + err.message;
        sync.textContent = "Sync failed.";
      }
    }

    function populateFilters(list) {
      const families = new Set();
      const rarities = new Set();
      const regions = new Set();

      list.forEach(e => {
        if (e.family) families.add(e.family);
        if (e.rarity) rarities.add(e.rarity);
        if (e.region) regions.add(e.region);
      });

      fillSelect("filterFamily", families);
      fillSelect("filterRarity", rarities);
      fillSelect("filterRegion", regions);
    }

    function fillSelect(id, values) {
      const sel = document.getElementById(id);
      [...values].sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = format(v);
        sel.appendChild(opt);
      });
    }

    function filterList() {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const fam = document.getElementById("filterFamily").value;
      const rar = document.getElementById("filterRarity").value;
      const reg = document.getElementById("filterRegion").value;

      const filtered = allEnemies.filter(e => {
        return (
          (!search || (e.name || "").toLowerCase().includes(search)) &&
          (!fam || e.family === fam) &&
          (!rar || e.rarity === rar) &&
          (!reg || e.region === reg)
        );
      });

      renderList(filtered);
    }

    function renderList(list) {
      const container = document.getElementById("enemyContainer");

      if (!list.length) {
        container.innerHTML = "<div>No enemies found.</div>";
        return;
      }

      container.innerHTML = list
        .map(e => {
          const rarityClass = "rarity-" + (String(e.rarity || "common").toLowerCase());
          return `
            <div class="enemy-card" onclick="viewEnemy('${encodeURIComponent(e.key)}')">
              <div class="enemy-main">
                <div class="enemy-name">${e.name}</div>
                <div class="enemy-sub">
                  ${format(e.family)} — ${format(e.variant)} — ${format(e.region || "Unknown Region")}
                </div>
              </div>
              <div class="rarity-pill ${rarityClass}">
                ${format(e.rarity || "common")}
              </div>
            </div>
          `;
        })
        .join("");
    }

    function viewEnemy(key) {
      window.location.href = `enemy.html?key=${key}`;
    }

    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function goToMap() {
      window.location.href = "world-map.html";
    }

    loadEnemies();
  </script>

</body>
</html>
