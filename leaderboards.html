<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Leaderboards</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #usernameDisplay {
      opacity:0.8;
      margin-bottom:20px;
    }

    .tabs {
      display:flex;
      gap:12px;
      margin-bottom:20px;
    }

    .tab {
      padding:8px 14px;
      border-radius:4px;
      border:1px solid #444;
      background:#1a1d24;
      cursor:pointer;
      transition:0.2s;
    }

    .tab:hover {
      background:#222832;
    }

    .tab.active {
      background:#222832;
      border-color:#7fffd4;
    }

    .leaderboard-row {
      display:grid;
      grid-template-columns: 50px 1fr 80px 80px 80px;
      padding:10px;
      background:#11141c;
      border:1px solid #262a36;
      border-radius:6px;
      margin-bottom:8px;
      font-size:14px;
      transition:0.2s;
    }

    .leaderboard-row:hover {
      background:#1a1d24;
    }

    .header-row {
      font-weight:bold;
      background:#1a1d24;
    }

    .btn {
      margin-top:16px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      width:100%;
      text-align:center;
    }

    .btn:hover {
      background:#222832;
    }
  </style>
</head>

<body>

  <h1>Leaderboards</h1>
  <div id="usernameDisplay"></div>

  <div class="tabs">
    <div class="tab active" id="tab-global" onclick="switchTab('global')">Global</div>
    <div class="tab" id="tab-hardcore" onclick="switchTab('hardcore')">Hardcore</div>
    <div class="tab" id="tab-friends" onclick="switchTab('friends')">Friends</div>
  </div>

  <div id="leaderboardContainer">Loading...</div>

  <button class="btn" onclick="refresh()">Refresh</button>
  <button class="btn" onclick="goToMap()">World Map</button>

  <script src="api.js"></script>

  <script>
    import { requireSession } from "./session-guard.js";
    const session = requireSession();
    if (!session) return;
    
    const username = sessionStorage.getItem("twitch_username");
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "Not logged in";

    let currentTab = "global";

    /* ============================================================
       TAB SWITCHING
       ============================================================ */

    function switchTab(tab) {
      currentTab = tab;

      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById("tab-" + tab).classList.add("active");

      loadLeaderboard();
    }

    /* ============================================================
       LOAD LEADERBOARD
       ============================================================ */

    async function loadLeaderboard() {
      const container = document.getElementById("leaderboardContainer");
      container.textContent = "Loading...";

      try {
        let data = [];

        if (currentTab === "global") {
          data = await api.getLeaderboardGlobal();
        } else if (currentTab === "hardcore") {
          data = await api.getLeaderboardHardcore();
        } else if (currentTab === "friends") {
          data = await api.getLeaderboardFriends(username);
        }

        renderLeaderboard(data);

      } catch (err) {
        container.textContent = "Error loading leaderboard: " + err.message;
      }
    }

    /* ============================================================
       RENDER LEADERBOARD
       ============================================================ */

    function renderLeaderboard(list) {
      const container = document.getElementById("leaderboardContainer");

      if (!list || list.length === 0) {
        container.innerHTML = "<div>No data available.</div>";
        return;
      }

      const header = `
        <div class="leaderboard-row header-row">
          <div>#</div>
          <div>Username</div>
          <div>Level</div>
          <div>Hardcore</div>
          <div>Max HP</div>
        </div>
      `;

      const rows = list
        .map((p, i) => `
          <div class="leaderboard-row">
            <div>${i + 1}</div>
            <div>${p.username}</div>
            <div>${p.level}</div>
            <div>${p.hardcore ? "Yes" : "No"}</div>
            <div>${p.maxHP}</div>
          </div>
        `)
        .join("");

      container.innerHTML = header + rows;
    }

    /* ============================================================
       BUTTON ACTIONS
       ============================================================ */

    function refresh() {
      loadLeaderboard();
    }

    function goToMap() {
      window.location.href = "world-map.html";
    }

    /* ============================================================
       INITIAL LOAD
       ============================================================ */

    loadLeaderboard();
  </script>

</body>
</html>
