<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enemy</title>

  <style>
    body {
      background:#0d0f14;
      color:#e8e8e8;
      font-family:system-ui, sans-serif;
      padding:24px;
    }

    h1 {
      color:#7fffd4;
      margin-bottom:4px;
    }

    #usernameDisplay {
      opacity:0.8;
      margin-bottom:16px;
    }

    .section {
      margin-top:24px;
      padding:16px;
      background:#11141c;
      border-radius:8px;
      border:1px solid #262a36;
    }

    .section h2 {
      margin-top:0;
      font-size:18px;
      color:#9af7ff;
    }

    .stat-row {
      display:flex;
      justify-content:space-between;
      padding:4px 0;
      border-bottom:1px solid #1c1f28;
      font-size:14px;
    }

    .stat-row:last-child {
      border-bottom:none;
    }

    .portrait-frame {
      width:160px;
      height:160px;
      border-radius:8px;
      overflow:hidden;
      border:2px solid #444;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      margin:0 auto;
      position:relative;
    }

    .portrait-img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .portrait-common { box-shadow:0 0 6px #bfbfbf55; }
    .portrait-uncommon { box-shadow:0 0 8px #7fff7f88; }
    .portrait-rare { box-shadow:0 0 8px #7fcfff88; }
    .portrait-epic { box-shadow:0 0 10px #c77fffaa; }
    .portrait-legendary { box-shadow:0 0 12px #ffbf5faa; }

    .tag-pill {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #444;
      font-size:11px;
      margin:2px;
      background:#1a1d24;
    }

    .btn {
      margin-top:16px;
      padding:10px 14px;
      border-radius:6px;
      border:1px solid #444;
      background:#1a1d24;
      color:#eee;
      cursor:pointer;
      text-align:center;
      min-width:140px;
    }

    .btn:hover {
      background:#222832;
    }

    .btn-row {
      margin-top:16px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .sync-indicator {
      font-size:12px;
      opacity:0.7;
      margin-bottom:8px;
    }
  </style>
</head>

<body>

  <h1>Enemy</h1>
  <div id="usernameDisplay"></div>
  <div class="sync-indicator" id="syncIndicator">Loading enemy...</div>

  <div id="enemyContainer">Loading...</div>

  <div class="btn-row">
    <button class="btn" onclick="goToBestiary()">Back to Bestiary</button>
    <button class="btn" onclick="goToMap()">World Map</button>
  </div>

  <script type="module">
    import { requireSession } from "./session-guard.js";
    const session = requireSession();
    if (!session) return;
  
    const username = session.username;
    document.getElementById("usernameDisplay").textContent =
      username ? "Logged in as: " + username : "No user logged in";
  
    const params = new URLSearchParams(window.location.search);
    const enemyKey = params.get("key");
  
    async function loadEnemy() {
      const container = document.getElementById("enemyContainer");
      const sync = document.getElementById("syncIndicator");
  
      if (!enemyKey) {
        container.textContent = "No enemy key provided.";
        sync.textContent = "Failed to load enemy.";
        return;
      }
  
      try {
        sync.textContent = "Loading enemy data...";
        const res = await fetch("data/enemies.json", { cache: "no-store" });
        if (!res.ok) {
          container.textContent = "Failed to load enemies.";
          sync.textContent = "Sync failed.";
          return;
        }
  
        const list = await res.json();
        const enemy = list.find(e => String(e.key) === String(enemyKey));
  
        if (!enemy) {
          container.textContent = "Enemy not found.";
          sync.textContent = "Enemy not found.";
          return;
        }
  
        renderEnemy(enemy);
        sync.textContent = "Enemy loaded.";
      } catch (err) {
        container.textContent = "Network error: " + err.message;
        sync.textContent = "Sync failed.";
      }
    }
  
    function renderEnemy(e) {
      const container = document.getElementById("enemyContainer");
  
      const rarityClass =
        "portrait-" + String(e.rarity || "common").toLowerCase();
  
      const tags = (e.tags || [])
        .map(t => `<span class="tag-pill">${format(t)}</span>`)
        .join(" ");
  
      container.innerHTML = `
        <div class="section">
          <div class="portrait-frame ${rarityClass}">
            <img class="portrait-img"
                 src="${e.portrait || "/assets/enemies/default.png"}"
                 onerror="this.src='/assets/enemies/default.png'">
          </div>
  
          <h2 style="text-align:center; margin-top:12px;">${e.name}</h2>
          <div style="text-align:center; opacity:0.8; font-size:13px;">
            ${format(e.family)} — ${format(e.variant)} — ${format(
        e.rarity || "common"
      )}
          </div>
  
          <div class="stat-row"><span>Level</span><span>${e.level || 1}</span></div>
          <div class="stat-row"><span>Element</span><span>${format(
            e.element || "none"
          )}</span></div>
          <div class="stat-row"><span>Region</span><span>${format(
            e.region || "Unknown"
          )}</span></div>
        </div>
  
        <div class="section">
          <h2>Base Stats</h2>
          <div class="stat-row"><span>HP</span><span>${e.baseHP ||
            e.maxHP ||
            "?"}</span></div>
          <div class="stat-row"><span>Attack</span><span>${e.baseATK ||
            e.attack ||
            "?"}</span></div>
          <div class="stat-row"><span>Defense</span><span>${e.baseDEF ||
            e.defense ||
            "?"}</span></div>
        </div>
  
        <div class="section">
          <h2>Tags & Traits</h2>
          ${tags || "<div>No special tags recorded.</div>"}
        </div>
  
        <div class="section">
          <h2>Flavor</h2>
          <div style="font-size:14px; opacity:0.9;">
            ${e.flavor || "No flavor text recorded yet."}
          </div>
        </div>
  
        <div class="section">
          <h2>Loot</h2>
          <div style="font-size:13px; opacity:0.9;">
            ${
              e.lootTable
                ? typeof e.lootTable === "string"
                  ? e.lootTable
                  : JSON.stringify(e.lootTable, null, 2)
                : "No loot table recorded."
            }
          </div>
        </div>
      `;
    }
  
    function format(str) {
      return String(str)
        .toLowerCase()
        .replace(/_/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }
  
    function goToBestiary() {
      window.location.href = "enemy-list.html";
    }
  
    function goToMap() {
      window.location.href = "world-map.html";
    }
  
    loadEnemy();
  </script>

</body>
</html>
